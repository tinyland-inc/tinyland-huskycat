# HuskyCat GitLab CI/CD Pipeline
# Production-ready pipeline with comprehensive validation, multi-architecture builds, and security scanning

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - local: '/.gitlab/ci/scheduled-updates.yml'
  - local: '/.gitlab/ci/pages.yml'

stages:
  - validate
  - security
  - test
  - build
  - package
  - sign
  - deploy
  - scheduled

variables:
  CONTAINER_REGISTRY: registry.gitlab.com/tinyland/ai/huskycat
  CONTAINER_TAG: $CI_COMMIT_SHORT_SHA
  UV_CACHE_DIR: $CI_PROJECT_DIR/.cache/uv
  PIP_CACHE_DIR: $CI_PROJECT_DIR/.cache/pip
  UV_VERSION: '0.5.8'
  PAGES_URL: https://tinyland.gitlab.io/ai/huskycat
  BUILDAH_FORMAT: docker
  BUILDAH_ISOLATION: chroot
  # Security scanning variables
  SAST_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'
  DS_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'

# Global cache configuration
.cache_template: &cache_template
  cache:
    key:
      files:
        - pyproject.toml
        - uv.lock
      prefix: $CI_JOB_NAME
    paths:
      - .cache/uv
      - .cache/pip
      - .venv/
    policy: pull-push

.uv_setup: &uv_setup
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version

# Container-based validation (after container build for parity)
validate:basic:
  stage: security
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  script:
    - echo "üê≥ Using HuskyCat container for validation parity"
    - which black && black --version
    - black --check src/
    - echo "‚úÖ Basic validation complete using container tools"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# MkDocs validation removed - handled by mkdocs:build job for Pages deployment

validate:yaml:
  stage: security
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  script:
    - echo "üê≥ Using HuskyCat container for YAML validation parity"
    - which yamllint && yamllint --version
    - yamllint .gitlab-ci.yml mkdocs.yml
    - find . -name "*.yml" -o -name "*.yaml" | grep -v .cache | xargs yamllint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Test stage jobs
test:unit:
  stage: test
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "üê≥ Using HuskyCat container with pre-installed tools"
    - which python3 && python3 --version
    - which pytest && pytest --version
    - pwd && ls -la
    - export HYPOTHESIS_PROFILE=ci
    - 'echo "Using Hypothesis profile: $HYPOTHESIS_PROFILE"'
    - pytest tests/test_*pbt.py -v --tb=short --hypothesis-profile=ci --timeout=300 --cov=src/
  coverage: '/TOTAL.*\s+(\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# E2E tests removed - tracked as future goals in docs/future-roadmap.md
# Previously included test:e2e:comprehensive, test:e2e:playwright, and test:e2e:deployment jobs
# These tested GitLab Pages deployment and MCP integration but were aspirational

test:mcp:server:
  stage: test
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "üê≥ Using HuskyCat container with pre-installed tools"
    - which python3 && python3 --version
    - which pytest && pytest --version
    - pwd && ls -la
    - pytest tests/test_mcp_server_pbt.py -v --tb=short
  artifacts:
    when: on_failure
    paths:
      - logs/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Build stage jobs - multi-architecture container builds
.container_build_template: &container_build_template
  stage: validate
  image: quay.io/buildah/stable:latest
  before_script:
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  after_script:
    - buildah logout $CI_REGISTRY

container:build:amd64:
  <<: *container_build_template
  variables:
    PLATFORM: linux/amd64
    ARCH: amd64
  script:
    - buildah build --platform=$PLATFORM -f ContainerFile -t $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH .
    - buildah push $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

container:build:arm64:
  <<: *container_build_template
  variables:
    PLATFORM: linux/arm64
    ARCH: arm64
  script:
    - buildah build --platform=$PLATFORM -f ContainerFile -t $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH .
    - buildah push $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

container:build:manifest:
  stage: build
  image: quay.io/buildah/stable:latest
  dependencies:
    - container:build:amd64
    - container:build:arm64
  before_script:
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Create multi-arch manifest for commit tag
    - buildah manifest create $CONTAINER_REGISTRY:$CONTAINER_TAG
    - buildah manifest add $CONTAINER_REGISTRY:$CONTAINER_TAG $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    - buildah manifest add $CONTAINER_REGISTRY:$CONTAINER_TAG $CONTAINER_REGISTRY:$CONTAINER_TAG-arm64
    - buildah manifest push --all $CONTAINER_REGISTRY:$CONTAINER_TAG
    # Create multi-arch manifest for latest tag (main branch only)
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ -n "$CI_COMMIT_TAG" ]; then
        buildah manifest create $CONTAINER_REGISTRY:latest
        buildah manifest add $CONTAINER_REGISTRY:latest $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
        buildah manifest add $CONTAINER_REGISTRY:latest $CONTAINER_REGISTRY:$CONTAINER_TAG-arm64
        buildah manifest push --all $CONTAINER_REGISTRY:latest
      fi
  after_script:
    - buildah logout $CI_REGISTRY
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# NOTE: container:build:dev job removed - ContainerFile.dev does not exist
# To re-enable, create ContainerFile.dev with development tools

# Stage 2: Complete validation using freshly built container
validate:complete:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  dependencies:
    - container:build:amd64
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üé† Stage 2 - Complete validation with fresh container"
    - docker pull $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    - echo "Running comprehensive validation with fresh container..."
    - |
      docker run --rm -v "$(pwd)":/workspace \
        $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64 \
        validate --all --allow-warnings
    - echo "‚úÖ Stage 2 validation complete - No recursive validation issues!"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false

# Package stage jobs
package:python:
  stage: package
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --dev
    - uv build
    - mkdir -p artifacts/
    - cp dist/*.tar.gz dist/*.whl artifacts/ 2>/dev/null || true
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.whl
      - artifacts/
    expire_in: 1 month
    name: 'huskycat-python-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

binary:build:linux:
  stage: package
  image: python:3.11-alpine
  needs:
    - job: validate:complete
      optional: true
  <<: *uv_setup
  <<: *cache_template
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev upx binutils zlib-dev
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
  script:
    - uv sync --extra build
    - mkdir -p dist/bin
    - uv run pyinstaller --onefile --name huskycat-linux-amd64 huskycat_main.py
    - mv dist/huskycat-linux-amd64 dist/bin/
    - chmod +x dist/bin/huskycat-linux-amd64
    - upx --best --lzma dist/bin/huskycat-linux-amd64 || echo "UPX compression failed, continuing without compression"
    - ls -la dist/bin/
    - file dist/bin/huskycat-linux-amd64 || true  # file command may not be available
    - dist/bin/huskycat-linux-amd64 --version || echo "Binary test failed, but continuing"
  artifacts:
    paths:
      - dist/bin/huskycat-linux-amd64
    expire_in: 1 month
    name: 'huskycat-linux-binary-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# Linux ARM64 binary build
binary:build:linux-arm64:
  stage: package
  image: python:3.11-slim
  tags:
    - arm64  # Requires ARM64 runner
  needs:
    - job: validate:complete
      optional: true
  <<: *cache_template
  before_script:
    - apt-get update && apt-get install -y git curl
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
  script:
    - uv sync --extra build
    - mkdir -p dist/bin
    - uv run pyinstaller --onefile --name huskycat-linux-arm64 huskycat_main.py
    - mv dist/huskycat-linux-arm64 dist/bin/
    - chmod +x dist/bin/huskycat-linux-arm64
    - ls -la dist/bin/
    - file dist/bin/huskycat-linux-arm64 || true  # file command may not be available
    - dist/bin/huskycat-linux-arm64 --version || echo "Binary test failed, but continuing"
  artifacts:
    paths:
      - dist/bin/huskycat-linux-arm64
    expire_in: 1 month
    name: 'huskycat-linux-arm64-binary-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# macOS ARM64 (Apple Silicon) build with signing - uses GitLab SaaS macOS runners
# Required CI/CD Variables:
#   APPLE_CERTIFICATE_BASE64 - Base64 encoded .p12 certificate
#   APPLE_CERTIFICATE_PASSWORD - Certificate password
#   APPLE_DEVELOPER_ID_APPLICATION - "Developer ID Application: Your Name (TEAMID)"
#   APPLE_ID - Apple ID email for notarization
#   APPLE_NOTARIZE_PASSWORD - App-specific password for notarization
#   APPLE_TEAM_ID - Team ID
.macos_saas_runners:
  tags:
    - saas-macos-medium-m1
  image: macos-14-xcode-15

# macOS ARM64 (Apple Silicon) build - UNSIGNED binary only
# Signing is handled separately in sign:darwin-arm64 job
binary:build:darwin-arm64:
  extends: .macos_saas_runners
  stage: package
  needs:
    - job: validate:complete
      optional: true
  before_script:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
    - uv sync --extra build
  script:
    - mkdir -p dist/bin
    # Build unsigned binary (signing done in separate sign stage)
    - uv run python build_binary.py --skip-upx
    - mv dist/huskycat dist/bin/huskycat-darwin-arm64
    - chmod +x dist/bin/huskycat-darwin-arm64
    # Verify
    - file dist/bin/huskycat-darwin-arm64
    - dist/bin/huskycat-darwin-arm64 --version
    - ls -la dist/bin/
  artifacts:
    paths:
      - dist/bin/huskycat-darwin-arm64
    expire_in: 1 month
    name: 'huskycat-darwin-arm64-binary-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# macOS ARM64 Code Signing and Notarization (separate sign stage)
sign:darwin-arm64:
  extends: .macos_saas_runners
  stage: sign
  needs:
    - job: binary:build:darwin-arm64
      optional: true
  variables:
    KEYCHAIN_NAME: "signing.keychain-db"
    KEYCHAIN_PASSWORD: "ci-keychain-password-$CI_PIPELINE_ID"
  script:
    - |
      # Check if binary exists
      if [ ! -f "dist/bin/huskycat-darwin-arm64" ]; then
        echo "‚ö†Ô∏è No binary to sign (darwin-arm64 build may have failed)"
        exit 0
      fi
      # Check if signing credentials are configured
      if [ -z "$APPLE_CERTIFICATE_BASE64" ] || [ -z "$APPLE_DEVELOPER_ID_APPLICATION" ]; then
        echo "‚ÑπÔ∏è No signing credentials configured, skipping signing"
        exit 0
      fi
      echo "üîê Setting up code signing..."
      security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
      security default-keychain -s "$KEYCHAIN_NAME"
      security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
      security set-keychain-settings -lut 3600 "$KEYCHAIN_NAME"
      # Import certificates
      echo "$APPLE_DEVELOPER_ID_CA_G2" | base64 -d > DeveloperIDG2CA.cer
      echo "$APPLE_WWDR_CA_G2" | base64 -d > AppleWWDRCAG2.cer
      security import DeveloperIDG2CA.cer -k "$KEYCHAIN_NAME" -T /usr/bin/codesign
      security import AppleWWDRCAG2.cer -k "$KEYCHAIN_NAME" -T /usr/bin/codesign
      rm DeveloperIDG2CA.cer AppleWWDRCAG2.cer
      echo "$APPLE_CERTIFICATE_BASE64" | base64 -d > certificate.p12
      security import certificate.p12 -k "$KEYCHAIN_NAME" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
      rm certificate.p12
      security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
      security find-identity -v -p codesigning "$KEYCHAIN_NAME"
      # Sign the binary
      codesign --force --options runtime \
        --sign "$APPLE_DEVELOPER_ID_APPLICATION" \
        --entitlements entitlements.plist \
        dist/bin/huskycat-darwin-arm64
      codesign --verify --verbose dist/bin/huskycat-darwin-arm64
      # Notarize if credentials available
      if [ -n "$APPLE_ID" ] && [ -n "$APPLE_NOTARIZE_PASSWORD" ] && [ -n "$APPLE_TEAM_ID" ]; then
        echo "üì§ Submitting for notarization..."
        zip -j huskycat-darwin-arm64.zip dist/bin/huskycat-darwin-arm64
        xcrun notarytool submit huskycat-darwin-arm64.zip \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_NOTARIZE_PASSWORD" \
          --team-id "$APPLE_TEAM_ID" \
          --wait || echo "Notarization failed or timed out"
        rm huskycat-darwin-arm64.zip
      fi
  after_script:
    - security delete-keychain "$KEYCHAIN_NAME" 2>/dev/null || true
  artifacts:
    paths:
      - dist/bin/huskycat-darwin-arm64
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
  allow_failure: true  # Signing is optional

# macOS AMD64 (Intel) build - DISABLED
# GitLab SaaS only provides ARM64 macOS runners. Cross-compilation from
# ARM64 to x86_64 is not possible with PyInstaller.
# This job is manual-only and will fail until an Intel runner is available.
binary:build:darwin-amd64:
  extends: .macos_saas_runners
  stage: package
  script:
    - echo "‚ùå macOS AMD64 builds are not supported on ARM64 runners"
    - echo "PyInstaller cannot cross-compile between architectures"
    - echo "This job requires an Intel macOS runner"
    - exit 1
  rules:
    - when: manual
      allow_failure: true

# Deploy stage jobs
release:create:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: package:python
      optional: true
    - job: binary:build:linux
      optional: true
    - job: binary:build:linux-arm64
      optional: true
    - job: sign:darwin-arm64
      optional: true
  script:
    - |
      release-cli create \
        --name "HuskyCat $CI_COMMIT_TAG" \
        --tag-name $CI_COMMIT_TAG \
        --description "Release $CI_COMMIT_TAG of HuskyCat Universal Code Validation Platform" \
        --assets-link "{\"name\":\"Linux AMD64 Binary\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-linux-amd64?job=binary:build:linux\"}" \
        --assets-link "{\"name\":\"Linux ARM64 Binary\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-linux-arm64?job=binary:build:linux-arm64\"}" \
        --assets-link "{\"name\":\"macOS ARM64 Binary (Apple Silicon)\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-darwin-arm64?job=sign:darwin-arm64\"}" \
        --assets-link "{\"name\":\"Python Wheel Package\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/browse/dist?job=package:python\"}" \
        --assets-link "{\"name\":\"Container Image\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/container_registry/$CI_COMMIT_TAG\"}" \
        --assets-link "{\"name\":\"Documentation\",\"url\":\"https://tinyland.gitlab.io/ai/huskycat/\"}"
  rules:
    - if: $CI_COMMIT_TAG
# Security scanning jobs (using GitLab security templates)
# These are automatically included via the templates at the top
