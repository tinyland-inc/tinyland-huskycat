# HuskyCat GitLab CI/CD Pipeline
# Production-ready pipeline with comprehensive validation, multi-architecture builds, and security scanning

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - local: '/.gitlab/ci/scheduled-updates.yml'
  - local: '/.gitlab/ci/pages.yml'

stages:
  - validate
  - security
  - test
  - build
  - package
  - deploy
  - scheduled

variables:
  CONTAINER_REGISTRY: registry.gitlab.com/tinyland/ai/huskycat
  CONTAINER_TAG: $CI_COMMIT_SHORT_SHA
  UV_CACHE_DIR: $CI_PROJECT_DIR/.cache/uv
  PIP_CACHE_DIR: $CI_PROJECT_DIR/.cache/pip
  UV_VERSION: '0.5.8'
  PAGES_URL: https://tinyland.gitlab.io/ai/huskycat
  BUILDAH_FORMAT: docker
  BUILDAH_ISOLATION: chroot
  # Security scanning variables
  SAST_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'
  DS_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'

# Global cache configuration
.cache_template: &cache_template
  cache:
    key:
      files:
        - pyproject.toml
        - uv.lock
      prefix: $CI_JOB_NAME
    paths:
      - .cache/uv
      - .cache/pip
      - .venv/
    policy: pull-push

.uv_setup: &uv_setup
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version

# Validation stage jobs
validate:code:
  stage: validate
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --dev
    - uv run black --check src/ tests/
    - uv run flake8 src/ tests/
    - uv run ruff check src/ tests/
    - uv run mypy src/ --ignore-missing-imports
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

mkdocs:validate:
  stage: validate
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --extra docs
    - uv run mkdocs build --strict --verbose --site-dir .tmp/site
  artifacts:
    when: on_failure
    paths:
      - .tmp/site/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

validate:yaml:
  stage: validate
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --dev
    - uv run yamllint .gitlab-ci.yml mkdocs.yml
    - find . -name "*.yml" -o -name "*.yaml" | grep -v .cache | xargs uv run yamllint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Test stage jobs
test:unit:
  stage: test
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --dev
    - uv run pytest tests/test_validation_pbt.py tests/test_unified_validation_pbt.py -v --tb=short --cov=src/ --cov-report=xml --cov-report=html --cov-report=term
  coverage: '/TOTAL.*\s+(\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

test:e2e:deployment:
  stage: test
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --dev
    - uv run python tests/test_e2e_deployment.py
  artifacts:
    when: on_failure
    paths:
      - logs/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

test:e2e:comprehensive:
  stage: test
  image: mcr.microsoft.com/playwright/python:v1.40.0-focal
  variables:
    PLAYWRIGHT_BROWSERS_PATH: /ms-playwright
  before_script:
    - apt-get update && apt-get install -y python3-pip curl
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
  script:
    - uv sync --dev
    - playwright install chromium
    - uv run python tests/e2e/run_e2e_tests.py --suite=all --skip-slow --headless
  artifacts:
    when: always
    paths:
      - reports/
      - test-results/
      - playwright-report/
    reports:
      junit:
        - reports/e2e-full-junit.xml
        - reports/playwright-results.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

test:e2e:playwright:
  stage: test
  image: mcr.microsoft.com/playwright/python:v1.40.0-focal
  variables:
    PLAYWRIGHT_BROWSERS_PATH: /ms-playwright
  before_script:
    - apt-get update && apt-get install -y python3-pip curl
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
  script:
    - uv sync --dev
    - playwright install chromium firefox
    - uv run python tests/e2e/run_e2e_tests.py --suite=playwright --headless --browser=chromium
  artifacts:
    when: always
    paths:
      - reports/playwright-report.html
      - playwright-report/
      - test-results/
    reports:
      junit: reports/playwright-junit.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

test:mcp:server:
  stage: test
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --dev
    - uv run pytest tests/test_mcp_server_pbt.py -v --tb=short
  artifacts:
    when: on_failure
    paths:
      - logs/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

mkdocs:build:
  stage: test
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --extra docs
    - uv run mkdocs build --verbose --site-dir public
  artifacts:
    paths:
      - public/
    expire_in: 1 week
    name: 'mkdocs-site-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Build stage jobs - multi-architecture container builds
.container_build_template: &container_build_template
  stage: build
  image: quay.io/buildah/stable:latest
  before_script:
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  after_script:
    - buildah logout $CI_REGISTRY

container:build:amd64:
  <<: *container_build_template
  variables:
    PLATFORM: linux/amd64
    ARCH: amd64
  script:
    - buildah build --platform=$PLATFORM -f ContainerFile -t $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH .
    - buildah push $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

container:build:arm64:
  <<: *container_build_template
  variables:
    PLATFORM: linux/arm64
    ARCH: arm64
  script:
    - buildah build --platform=$PLATFORM -f ContainerFile -t $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH .
    - buildah push $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

container:build:manifest:
  stage: build
  image: quay.io/buildah/stable:latest
  dependencies:
    - container:build:amd64
    - container:build:arm64
  before_script:
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Create multi-arch manifest for commit tag
    - buildah manifest create $CONTAINER_REGISTRY:$CONTAINER_TAG
    - buildah manifest add $CONTAINER_REGISTRY:$CONTAINER_TAG $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    - buildah manifest add $CONTAINER_REGISTRY:$CONTAINER_TAG $CONTAINER_REGISTRY:$CONTAINER_TAG-arm64
    - buildah manifest push --all $CONTAINER_REGISTRY:$CONTAINER_TAG
    # Create multi-arch manifest for latest tag (main branch only)
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ -n "$CI_COMMIT_TAG" ]; then
        buildah manifest create $CONTAINER_REGISTRY:latest
        buildah manifest add $CONTAINER_REGISTRY:latest $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
        buildah manifest add $CONTAINER_REGISTRY:latest $CONTAINER_REGISTRY:$CONTAINER_TAG-arm64
        buildah manifest push --all $CONTAINER_REGISTRY:latest
      fi
  after_script:
    - buildah logout $CI_REGISTRY
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

container:build:dev:
  <<: *container_build_template
  script:
    - buildah build -f ContainerFile.dev -t $CONTAINER_REGISTRY:dev-$CONTAINER_TAG .
    - buildah build -f ContainerFile.dev -t $CONTAINER_REGISTRY:dev-latest .
    - buildah push $CONTAINER_REGISTRY:dev-$CONTAINER_TAG
    - buildah push $CONTAINER_REGISTRY:dev-latest
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/

# Package stage jobs
package:python:
  stage: package
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --dev
    - uv build
    - mkdir -p artifacts/
    - cp dist/*.tar.gz dist/*.whl artifacts/ 2>/dev/null || true
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.whl
      - artifacts/
    expire_in: 1 month
    name: 'huskycat-python-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

binary:build:linux:
  stage: package
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev upx binutils zlib-dev
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
  script:
    - uv sync --extra build
    - mkdir -p dist/bin
    - uv run pyinstaller --onefile --name huskycat-linux-amd64 src/__main__.py
    - mv dist/huskycat-linux-amd64 dist/bin/
    - chmod +x dist/bin/huskycat-linux-amd64
    - upx --best --lzma dist/bin/huskycat-linux-amd64 || echo "UPX compression failed, continuing without compression"
    - ls -la dist/bin/
    - file dist/bin/huskycat-linux-amd64
    - dist/bin/huskycat-linux-amd64 --version || echo "Binary test failed, but continuing"
  artifacts:
    paths:
      - dist/bin/huskycat-linux-amd64
    expire_in: 1 month
    name: 'huskycat-linux-binary-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

binary:build:macos:
  stage: package
  # Use a macOS runner/image if available, otherwise cross-compile
  # For now, we'll simulate this with a cross-compilation attempt
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
  script:
    - uv sync --extra build
    - mkdir -p dist/bin
    - echo "macOS binary build would require macOS runner or cross-compilation setup"
    - echo "Creating placeholder macOS binary info file"
    - echo "HuskyCat macOS Binary - Build $CI_COMMIT_SHORT_SHA" > dist/bin/huskycat-macos-info.txt
    - 'echo "Built on: $(date)" >> dist/bin/huskycat-macos-info.txt'
    - 'echo "Commit: $CI_COMMIT_SHA" >> dist/bin/huskycat-macos-info.txt'
  artifacts:
    paths:
      - dist/bin/huskycat-macos-info.txt
    expire_in: 1 month
    name: 'huskycat-macos-binary-$CI_COMMIT_SHORT_SHA'
  allow_failure: true # Allow this job to fail since it's a placeholder
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# Deploy stage jobs
pages:
  stage: deploy
  image: python:3.11-alpine
  dependencies:
    - mkdocs:build
    - test:unit
  <<: *uv_setup
  <<: *cache_template
  script:
    # Use pre-built documentation from mkdocs:build job
    - ls -la public/ || echo "No pre-built documentation found, building now..."
    - |
      if [ ! -d "public" ]; then
        echo "Building documentation as it wasn't found in artifacts..."
        uv sync --extra docs
        uv run mkdocs build --site-dir public
      fi

    # Create enhanced downloads page for artifacts
    - mkdir -p public/downloads public/coverage

    # Copy coverage reports if available
    - cp -r htmlcov/* public/coverage/ 2>/dev/null || echo "No coverage reports found"

    # Create comprehensive downloads page
    - |
      cat > public/downloads/index.html << EOF
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>HuskyCat Downloads</title>
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 40px; line-height: 1.6; }
          .downloads { display: grid; gap: 20px; margin: 20px 0; }
          .download-section { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007acc; }
          .download-links { list-style: none; padding: 0; }
          .download-links li { margin: 10px 0; }
          .download-links a { text-decoration: none; color: #007acc; font-weight: 500; }
          .download-links a:hover { text-decoration: underline; }
          pre { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; overflow-x: auto; }
        </style>
      </head>
      <body>
        <h1>HuskyCat Downloads</h1>
        <p>Download the latest binaries, packages, and resources from our GitLab CI/CD pipeline.</p>
        
        <div class="downloads">
          <div class="download-section">
            <h2>üêß Linux Binaries</h2>
            <ul class="download-links">
              <li><a href="https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/main/raw/dist/bin/huskycat-linux-amd64?job=binary:build:linux">Linux AMD64 Binary (Direct Download)</a></li>
            </ul>
          </div>
          
          <div class="download-section">
            <h2>üêç Python Packages</h2>
            <ul class="download-links">
              <li><a href="https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/main/browse/dist?job=package:python">Python Packages (Wheel & Source)</a></li>
              <li><a href="https://pypi.org/project/huskycat/">PyPI Package</a></li>
            </ul>
          </div>
          
          <div class="download-section">
            <h2>üê≥ Container Images</h2>
            <ul class="download-links">
              <li><a href="https://gitlab.com/tinyland/ai/huskycat/container_registry">Multi-Architecture Container Registry</a></li>
              <li>Latest: <code>registry.gitlab.com/tinyland/ai/huskycat:latest</code></li>
              <li>AMD64: <code>registry.gitlab.com/tinyland/ai/huskycat:latest-amd64</code></li>
              <li>ARM64: <code>registry.gitlab.com/tinyland/ai/huskycat:latest-arm64</code></li>
            </ul>
          </div>
          
          <div class="download-section">
            <h2>üìä Quality Reports</h2>
            <ul class="download-links">
              <li><a href="../coverage/">Code Coverage Report</a></li>
            </ul>
          </div>
        </div>
        
        <h2>üöÄ Quick Install</h2>
        <h3>Using curl (recommended):</h3>
        <pre><code>curl -sSL https://tinyland.gitlab.io/ai/huskycat/install.sh | bash</code></pre>
        
        <h3>Using pip:</h3>
        <pre><code>pip install huskycat</code></pre>
        
        <h3>Using container:</h3>
        <pre><code>podman run --rm -v \$(pwd):/workspace registry.gitlab.com/tinyland/ai/huskycat:latest</code></pre>
        
        <p><em>Built from commit: $CI_COMMIT_SHA | Build date: $(date)</em></p>
      </body>
      </html>
      EOF

    # Create simple install script
    - |
      cat > public/install.sh << EOF
      #!/bin/bash
      set -e

      echo "Installing HuskyCat..."

      # Detect architecture and OS
      ARCH=\$(uname -m)
      OS=\$(uname -s | tr '[:upper:]' '[:lower:]')

      case \$ARCH in
        x86_64|amd64) ARCH="amd64" ;;
        aarch64|arm64) ARCH="arm64" ;;
        *) echo "Unsupported architecture: \$ARCH"; exit 1 ;;
      esac

      if [ "\$OS" = "linux" ]; then
        BINARY_URL="https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/main/raw/dist/bin/huskycat-linux-amd64?job=binary:build:linux"
        echo "Downloading Linux binary..."
        curl -sSL "\$BINARY_URL" -o /usr/local/bin/huskycat
        chmod +x /usr/local/bin/huskycat
        echo "HuskyCat installed successfully!"
        echo "Run 'huskycat --version' to verify installation."
      else
        echo "Binary installation not available for \$OS, falling back to pip..."
        pip install huskycat
      fi
      EOF

    - chmod +x public/install.sh
  artifacts:
    paths:
      - public
    expire_in: never
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

release:create:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  dependencies:
    - package:python
    - binary:build:linux
  script:
    - |
      release-cli create \
        --name "HuskyCat $CI_COMMIT_TAG" \
        --tag-name $CI_COMMIT_TAG \
        --description "Release $CI_COMMIT_TAG of HuskyCat Universal Code Validation Platform" \
        --assets-link "{\"name\":\"Linux AMD64 Binary\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-linux-amd64?job=binary:build:linux\"}" \
        --assets-link "{\"name\":\"Python Wheel Package\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/browse/dist?job=package:python\"}" \
        --assets-link "{\"name\":\"Container Image\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/container_registry/$CI_COMMIT_TAG\"}" \
        --assets-link "{\"name\":\"Documentation\",\"url\":\"https://tinyland.gitlab.io/ai/huskycat/\"}"
  rules:
    - if: $CI_COMMIT_TAG
# Security scanning jobs (using GitLab security templates)
# These are automatically included via the templates at the top
