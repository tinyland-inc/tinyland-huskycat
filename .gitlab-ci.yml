# HuskyCat GitLab CI/CD Pipeline
# Production-ready pipeline with comprehensive validation, multi-architecture builds, and security scanning

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - local: '/.gitlab/ci/scheduled-updates.yml'
  - local: '/.gitlab/ci/pages.yml'
  - local: '/.gitlab/ci/e2e-tests.yml'
  - local: '/.gitlab/ci/download-tools.yml'
  - local: '/.gitlab/ci/build.yml'
  - local: '/.gitlab/ci/binary-tests.yml'
  # Packaging and distribution
  - local: '/.gitlab/ci/assets.yml'
  - local: '/.gitlab/ci/fpm-packages.yml'
  - local: '/.gitlab/ci/macos-pkg.yml'
  - local: '/.gitlab/ci/sbom.yml'

stages:
  - validate
  - security
  - build  # Tool downloads happen here
  - test
  - package  # Binary builds happen here (depends on build stage)
  - sign     # Code signing (after package)
  - deploy
  - scheduled

variables:
  CONTAINER_REGISTRY: registry.gitlab.com/tinyland/ai/huskycat
  CONTAINER_TAG: $CI_COMMIT_SHORT_SHA
  UV_CACHE_DIR: $CI_PROJECT_DIR/.cache/uv
  PIP_CACHE_DIR: $CI_PROJECT_DIR/.cache/pip
  UV_VERSION: '0.5.8'
  PAGES_URL: https://huskycat-570fbd.gitlab.io
  BUILDAH_FORMAT: docker
  BUILDAH_ISOLATION: chroot
  # Performance optimizations (from CI research)
  GIT_DEPTH: 50
  GIT_STRATEGY: fetch
  # Security scanning variables
  SAST_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'
  DS_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'

# Global cache configuration - inline for package:python job

.uv_setup: &uv_setup
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version

# Retry template for transient runner failures
# Based on crush-dots CI patterns for GitLab SaaS runner resilience
.retry_transient: &retry_transient
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - job_execution_timeout
      - api_failure
      - scheduler_failure

# Container-based validation (after container build for parity)
validate:basic:
  stage: security
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  interruptible: true
  script:
    - echo "üê≥ Using HuskyCat container for validation parity"
    - which black && black --version
    - black --check src/
    - echo "‚úÖ Basic validation complete using container tools"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# MkDocs validation removed - handled by mkdocs:build job for Pages deployment

validate:yaml:
  stage: security
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  interruptible: true
  script:
    - echo "üê≥ Using HuskyCat container for YAML validation parity"
    - which yamllint && yamllint --version
    - yamllint .gitlab-ci.yml mkdocs.yml
    - find . -name "*.yml" -o -name "*.yaml" | grep -v .cache | xargs yamllint
  allow_failure: true  # Don't block pipeline on runner infrastructure issues
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Test stage jobs
test:unit:
  stage: test
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  <<: *retry_transient
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "üê≥ Using HuskyCat container with pre-installed tools"
    - which python3 && python3 --version
    - which pytest && pytest --version
    - pwd && ls -la
    - export HYPOTHESIS_PROFILE=ci
    - 'echo "Using Hypothesis profile: $HYPOTHESIS_PROFILE"'
    - pytest tests/test_*pbt.py -v --tb=short --hypothesis-profile=ci --timeout=300 --cov=src/
  coverage: '/TOTAL.*\s+(\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# E2E tests removed - tracked as future goals in docs/future-roadmap.md
# Previously included test:e2e:comprehensive, test:e2e:playwright, and test:e2e:deployment jobs
# These tested GitLab Pages deployment and MCP integration but were aspirational

test:mcp:server:
  stage: test
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  <<: *retry_transient
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "üê≥ Using HuskyCat container with pre-installed tools"
    - which python3 && python3 --version
    - which pytest && pytest --version
    - pwd && ls -la
    - pytest tests/test_mcp_server_pbt.py -v --tb=short
  artifacts:
    when: on_failure
    paths:
      - logs/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Build stage jobs - multi-architecture container builds
# Using Docker-in-Docker following crush-dots patterns for Tinyland runners
# NOTE: TLS disabled, explicit --tls=false in service command
.container_build_template: &container_build_template
  stage: validate
  image: docker:25.0-cli
  timeout: 2h  # Extended timeout for slow DinD container builds
  services:
    - name: docker:25.0-dind
      command: ["--tls=false", "--dns=8.8.8.8", "--dns=1.1.1.1"]
  tags:
    - dind
    - linux  # Target Rocky Linux runner (excludes Darwin M1 which has 'darwin' tag)
  <<: *retry_transient
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - |
      echo "Waiting for Docker daemon (max 60s)..."
      ATTEMPTS=0; MAX=30
      until docker info >/dev/null 2>&1; do
        ATTEMPTS=$((ATTEMPTS + 1))
        [ $ATTEMPTS -ge $MAX ] && echo "Docker not ready after 60s" && exit 1
        sleep 2
      done
      docker version
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

container:build:amd64:
  <<: *container_build_template
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    ARCH: amd64
  script:
    - echo "Building container for linux/amd64 using Docker-in-Docker..."
    - docker build -f ContainerFile -t $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH .
    - docker push $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# NOTE: Linux ARM64 container builds removed - not a supported platform
# HuskyCat supports: Linux AMD64, macOS ARM64 (Apple Silicon)

# NOTE: Manifest job simplified - only amd64 platform supported
# Multi-arch manifests removed since we only build linux/amd64 containers
container:tag:latest:
  stage: build
  image: docker:25.0-cli
  services:
    - name: docker:25.0-dind
      command: ["--tls=false", "--dns=8.8.8.8", "--dns=1.1.1.1"]
  tags:
    - dind
    - linux  # Target Rocky Linux runner (excludes Darwin M1 which has 'darwin' tag)
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  needs:
    - container:build:amd64
  before_script:
    - |
      ATTEMPTS=0; MAX=30
      until docker info >/dev/null 2>&1; do
        ATTEMPTS=$((ATTEMPTS + 1))
        [ $ATTEMPTS -ge $MAX ] && echo "Docker not ready" && exit 1
        sleep 2
      done
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Tag commit SHA (without -amd64 suffix)
    - docker pull $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    - docker tag $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64 $CONTAINER_REGISTRY:$CONTAINER_TAG
    - docker push $CONTAINER_REGISTRY:$CONTAINER_TAG
    # Tag latest (main branch only)
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ -n "$CI_COMMIT_TAG" ]; then
        docker tag $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64 $CONTAINER_REGISTRY:latest
        docker push $CONTAINER_REGISTRY:latest
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# NOTE: container:build:dev job removed - ContainerFile.dev does not exist
# To re-enable, create ContainerFile.dev with development tools

# Stage 2: Complete validation using freshly built container
validate:complete:
  stage: build
  image: docker:25.0-cli
  services:
    - name: docker:25.0-dind
      command: ["--tls=false", "--dns=8.8.8.8", "--dns=1.1.1.1"]
  tags:
    - dind
    - linux  # Target Rocky Linux runner (excludes Darwin M1 which has 'darwin' tag)
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  dependencies:
    - container:build:amd64
  before_script:
    - |
      ATTEMPTS=0; MAX=30
      until docker info >/dev/null 2>&1; do
        ATTEMPTS=$((ATTEMPTS + 1))
        [ $ATTEMPTS -ge $MAX ] && echo "Docker not ready" && exit 1
        sleep 2
      done
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üé† Stage 2 - Complete validation with fresh container"
    - docker pull $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    - echo "Running comprehensive validation with fresh container..."
    - |
      docker run --rm -v "$(pwd)":/workspace \
        $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64 \
        validate --all --allow-warnings
    - echo "‚úÖ Stage 2 validation complete - No recursive validation issues!"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false

# Package stage jobs
package:python:
  stage: package
  image: python:3.11-alpine
  <<: *uv_setup
  cache:
    key:
      files:
        - pyproject.toml
        - uv.lock
      prefix: $CI_JOB_NAME
    paths:
      - .cache/uv
      - .cache/pip
      - .venv/
    policy: pull-push
  script:
    - uv sync --dev
    - uv build
    - mkdir -p artifacts/
    - cp dist/*.tar.gz dist/*.whl artifacts/ 2>/dev/null || true
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.whl
      - artifacts/
    expire_in: 1 month
    name: 'huskycat-python-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
  allow_failure: true  # Don't block binary tests if Python packaging fails

# NOTE: Binary build jobs are in .gitlab/ci/build.yml
# Supported platforms: linux-amd64, darwin-arm64
# See .gitlab/ci/build.yml for:
#   - build:binary:linux-amd64
#   - build:binary:darwin-arm64
# These jobs depend on download:tools:* jobs from .gitlab/ci/download-tools.yml

# macOS ARM64 (Apple Silicon) build with signing - uses GitLab SaaS macOS runners
# Required CI/CD Variables:
#   APPLE_CERTIFICATE_BASE64 - Base64 encoded .p12 certificate
#   APPLE_CERTIFICATE_PASSWORD - Certificate password
#   APPLE_DEVELOPER_ID_APPLICATION - "Developer ID Application: Your Name (TEAMID)"
#   APPLE_ID - Apple ID email for notarization
#   APPLE_NOTARIZE_PASSWORD - App-specific password for notarization
#   APPLE_TEAM_ID - Team ID
.macos_saas_runners:
  tags:
    - native
    - darwin

# Old binary:build:darwin-arm64 job (replaced by build:binary:darwin-arm64 in build.yml)
# The new version includes embedded validation tools
# binary:build:darwin-arm64:
#   extends: .macos_saas_runners
#   stage: package
#   ...

# NOTE: sign:darwin-arm64 job is defined in .gitlab/ci/macos-pkg.yml
# Uses the cleaner .keychain_setup template for code signing

# Deploy stage jobs
release:create:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: package:python
      optional: true
    - job: build:binary:linux-amd64
      optional: true
    - job: sign:darwin-arm64
      optional: true
    - job: checksums:generate
      optional: true
  script:
    - |
      release-cli create \
        --name "HuskyCat $CI_COMMIT_TAG" \
        --tag-name $CI_COMMIT_TAG \
        --description "Release $CI_COMMIT_TAG of HuskyCat Universal Code Validation Platform - Fat binaries with embedded validation tools" \
        --assets-link "{\"name\":\"Linux AMD64 Binary (Fat)\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-linux-amd64?job=build:binary:linux-amd64\"}" \
        --assets-link "{\"name\":\"macOS ARM64 Binary (Apple Silicon - Signed, Fat)\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-darwin-arm64?job=sign:darwin-arm64\"}" \
        --assets-link "{\"name\":\"SHA256 Checksums\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/SHA256SUMS.txt?job=checksums:generate\"}" \
        --assets-link "{\"name\":\"Python Wheel Package\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/browse/dist?job=package:python\"}" \
        --assets-link "{\"name\":\"Container Image\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/container_registry/$CI_COMMIT_TAG\"}" \
        --assets-link "{\"name\":\"Documentation\",\"url\":\"https://tinyland.gitlab.io/ai/huskycat/\"}"
  rules:
    - if: $CI_COMMIT_TAG
# Security scanning jobs (using GitLab security templates)
# These are automatically included via the templates at the top
