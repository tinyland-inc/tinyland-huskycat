# HuskyCat GitLab CI/CD Pipeline
# Production-ready pipeline with comprehensive validation, multi-architecture builds, and security scanning

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - local: '/.gitlab/ci/scheduled-updates.yml'
  - local: '/.gitlab/ci/pages.yml'
  - local: '/.gitlab/ci/e2e-tests.yml'
  # NOTE: download-tools.yml removed - jobs defined inline due to include issues
  - local: '/.gitlab/ci/build.yml'
  - local: '/.gitlab/ci/binary-tests.yml'
  # Packaging and distribution
  - local: '/.gitlab/ci/assets.yml'
  - local: '/.gitlab/ci/fpm-packages.yml'
  - local: '/.gitlab/ci/macos-pkg.yml'
  - local: '/.gitlab/ci/sbom.yml'
  # Reproducible builds
  - local: '/.gitlab/ci/nix.yml'

stages:
  - validate
  - security
  - build  # Tool downloads happen here
  - test
  - package  # Binary builds happen here (depends on build stage)
  - sign     # Code signing (after package)
  - deploy
  - scheduled

variables:
  CONTAINER_REGISTRY: registry.gitlab.com/tinyland/ai/huskycat
  CONTAINER_TAG: $CI_COMMIT_SHORT_SHA
  UV_CACHE_DIR: $CI_PROJECT_DIR/.cache/uv
  PIP_CACHE_DIR: $CI_PROJECT_DIR/.cache/pip
  UV_VERSION: '0.5.8'
  PAGES_URL: https://huskycat-570fbd.gitlab.io
  BUILDAH_FORMAT: docker
  BUILDAH_ISOLATION: chroot
  # Performance optimizations (from CI research)
  GIT_DEPTH: 50
  GIT_STRATEGY: fetch
  # Security scanning variables
  SAST_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'
  DS_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'

# Global cache configuration - inline for package:python job

.uv_setup: &uv_setup
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version

# Retry template for transient runner failures
# Based on crush-dots CI patterns for GitLab SaaS runner resilience
.retry_transient: &retry_transient
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - job_execution_timeout
      - api_failure
      - scheduler_failure

# Download tools for fat binary builds
# NOTE: Defined here because .gitlab/ci/download-tools.yml include wasn't working
download:tools:linux-amd64:
  stage: package
  image: python:3.11-slim
  needs: []
  tags:
    - linux
  cache:
    key: "tools-linux-amd64-v2.0.0"  # Version lock
    paths:
      - dist/tools/linux-amd64
    policy: pull-push
  script:
    - apt-get update -qq
    - apt-get install -y --no-install-recommends curl ca-certificates xz-utils gzip
    # Use pip directly (already in python:3.11-slim), not pip3 via apt-get
    - pip install --no-cache-dir requests pyyaml
    - mkdir -p dist/tools/linux-amd64
    # Checkpoint 1: Download shellcheck (skip if exists)
    - |
      if [ ! -f dist/tools/linux-amd64/shellcheck ]; then
        echo "Downloading shellcheck..."
        python3 scripts/download_tools.py --tool shellcheck --platform linux-amd64 --output-dir dist/tools
      else
        echo "Using cached shellcheck"
      fi
    # Checkpoint 2: Download hadolint (skip if exists)
    - |
      if [ ! -f dist/tools/linux-amd64/hadolint ]; then
        echo "Downloading hadolint..."
        python3 scripts/download_tools.py --tool hadolint --platform linux-amd64 --output-dir dist/tools
      else
        echo "Using cached hadolint"
      fi
    # Checkpoint 3: Download taplo (skip if exists)
    - |
      if [ ! -f dist/tools/linux-amd64/taplo ]; then
        echo "Downloading taplo..."
        python3 scripts/download_tools.py --tool taplo --platform linux-amd64 --output-dir dist/tools
      else
        echo "Using cached taplo"
      fi
    - echo "All tools downloaded for linux-amd64"
    - ls -lah dist/tools/linux-amd64
    - cat dist/tools/linux-amd64/versions.txt || echo "Version manifest will be created on next full run"
  artifacts:
    paths:
      - dist/tools
    expire_in: 1 month
    when: always  # Save partial downloads even on failure
  timeout: 15m

download:tools:darwin-arm64:
  stage: package
  image: python:3.11-slim
  needs: []
  tags:
    - linux
  cache:
    key: "tools-darwin-arm64-v2.0.0"  # Version lock
    paths:
      - dist/tools/darwin-arm64
    policy: pull-push
  script:
    - apt-get update -qq
    - apt-get install -y --no-install-recommends curl ca-certificates xz-utils gzip
    # Use pip directly (already in python:3.11-slim), not pip3 via apt-get
    - pip install --no-cache-dir requests pyyaml
    - mkdir -p dist/tools/darwin-arm64
    # Checkpoint 1: Download shellcheck (skip if exists)
    - |
      if [ ! -f dist/tools/darwin-arm64/shellcheck ]; then
        echo "Downloading shellcheck..."
        python3 scripts/download_tools.py --tool shellcheck --platform darwin-arm64 --output-dir dist/tools
      else
        echo "Using cached shellcheck"
      fi
    # Checkpoint 2: Download hadolint (skip if exists)
    - |
      if [ ! -f dist/tools/darwin-arm64/hadolint ]; then
        echo "Downloading hadolint..."
        python3 scripts/download_tools.py --tool hadolint --platform darwin-arm64 --output-dir dist/tools
      else
        echo "Using cached hadolint"
      fi
    # Checkpoint 3: Download taplo (skip if exists)
    - |
      if [ ! -f dist/tools/darwin-arm64/taplo ]; then
        echo "Downloading taplo..."
        python3 scripts/download_tools.py --tool taplo --platform darwin-arm64 --output-dir dist/tools
      else
        echo "Using cached taplo"
      fi
    - echo "All tools downloaded for darwin-arm64"
    - ls -lah dist/tools/darwin-arm64
    - cat dist/tools/darwin-arm64/versions.txt || echo "Version manifest will be created on next full run"
  artifacts:
    paths:
      - dist/tools
    expire_in: 1 month
    when: always  # Save partial downloads even on failure
  timeout: 15m

# MkDocs validation removed - handled by mkdocs:build job for Pages deployment
# validate:basic removed - redundant with validate:complete (Phase 2 optimization)

validate:yaml:
  stage: security
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  interruptible: true
  script:
    - echo "Using HuskyCat container for YAML validation parity"
    - which yamllint && yamllint --version
    - yamllint .gitlab-ci.yml mkdocs.yml
    - find . -name "*.yml" -o -name "*.yaml" | grep -v .cache | xargs yamllint
  allow_failure: true  # Don't block pipeline on runner infrastructure issues
  rules:
    # Always run on main and tags
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    # For MRs, only run when YAML files change
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.yml"
        - "**/*.yaml"

# Test stage jobs
# Using changes: rules for incremental test selection (Phase 3 optimization)
test:unit:
  stage: test
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  <<: *retry_transient
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "Using HuskyCat container with pre-installed tools"
    - which python3 && python3 --version
    - which pytest && pytest --version
    - pwd && ls -la
    - export HYPOTHESIS_PROFILE=ci
    - 'echo "Using Hypothesis profile: $HYPOTHESIS_PROFILE"'
    - pytest tests/test_*pbt.py -v --tb=short --hypothesis-profile=ci --timeout=300 --cov=src/
  coverage: '/TOTAL.*\s+(\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  rules:
    # Always run on main branch and tags (release builds)
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    # For MRs, only run when relevant files change
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - src/**/*.py
        - tests/test_*.py
        - pyproject.toml
        - uv.lock

# E2E tests removed - tracked as future goals in docs/future-roadmap.md
# Previously included test:e2e:comprehensive, test:e2e:playwright, and test:e2e:deployment jobs
# These tested GitLab Pages deployment and MCP integration but were aspirational

test:mcp:server:
  stage: test
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  <<: *retry_transient
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "Using HuskyCat container with pre-installed tools"
    - which python3 && python3 --version
    - which pytest && pytest --version
    - pwd && ls -la
    - pytest tests/test_mcp_server_pbt.py -v --tb=short
  artifacts:
    when: on_failure
    paths:
      - logs/
    expire_in: 1 week
  rules:
    # Always run on main and tags
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    # For MRs, only run when MCP-related files change
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - src/huskycat/mcp_server.py
        - src/huskycat/mcp/**/*.py
        - tests/test_mcp*.py

# Build stage jobs - multi-architecture container builds
# Using Docker-in-Docker following crush-dots patterns for Tinyland runners
# NOTE: TLS disabled, explicit --tls=false in service command
.container_build_template: &container_build_template
  stage: validate
  image: docker:25.0-cli
  timeout: 2h  # Extended timeout for slow DinD container builds
  services:
    - name: docker:25.0-dind
      command: ["--tls=false", "--dns=8.8.8.8", "--dns=1.1.1.1"]
  tags:
    - dind
    - linux  # Target Rocky Linux runner (excludes Darwin M1 which has 'darwin' tag)
  <<: *retry_transient
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - |
      echo "Waiting for Docker daemon (max 60s)..."
      ATTEMPTS=0; MAX=30
      until docker info >/dev/null 2>&1; do
        ATTEMPTS=$((ATTEMPTS + 1))
        [ $ATTEMPTS -ge $MAX ] && echo "Docker not ready after 60s" && exit 1
        sleep 2
      done
      docker version
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

container:build:amd64:
  <<: *container_build_template
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    ARCH: amd64
    DOCKER_BUILDKIT: "1"
    BUILDKIT_INLINE_CACHE: "1"
  script:
    - echo "Building container for linux/amd64 using Docker-in-Docker with BuildKit cache..."
    - |
      docker build -f ContainerFile \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --cache-from $CONTAINER_REGISTRY:latest-$ARCH \
        --cache-from $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH \
        -t $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH .
    - docker push $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# NOTE: Linux ARM64 container builds removed - not a supported platform
# HuskyCat supports: Linux AMD64, macOS ARM64 (Apple Silicon)

# NOTE: Manifest job simplified - only amd64 platform supported
# Multi-arch manifests removed since we only build linux/amd64 containers
container:tag:latest:
  stage: build
  image: docker:25.0-cli
  services:
    - name: docker:25.0-dind
      command: ["--tls=false", "--dns=8.8.8.8", "--dns=1.1.1.1"]
  tags:
    - dind
    - linux  # Target Rocky Linux runner (excludes Darwin M1 which has 'darwin' tag)
  <<: *retry_transient
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  needs:
    - container:build:amd64
  before_script:
    # Extended timeout (90s) for DinD startup
    - |
      echo "Waiting for Docker daemon (max 90s)..."
      ATTEMPTS=0; MAX=45
      until docker info >/dev/null 2>&1; do
        ATTEMPTS=$((ATTEMPTS + 1))
        [ $ATTEMPTS -ge $MAX ] && echo "Docker not ready after 90s" && exit 1
        sleep 2
      done
      docker version
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Tag commit SHA (without -amd64 suffix)
    - docker pull $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    - docker tag $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64 $CONTAINER_REGISTRY:$CONTAINER_TAG
    - docker push $CONTAINER_REGISTRY:$CONTAINER_TAG
    # Tag latest (main branch only)
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ -n "$CI_COMMIT_TAG" ]; then
        docker tag $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64 $CONTAINER_REGISTRY:latest
        docker push $CONTAINER_REGISTRY:latest
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# NOTE: container:build:dev job removed - ContainerFile.dev does not exist
# To re-enable, create ContainerFile.dev with development tools

# Stage 2: Complete validation using freshly built container
validate:complete:
  stage: build
  image: docker:25.0-cli
  services:
    - name: docker:25.0-dind
      command: ["--tls=false", "--dns=8.8.8.8", "--dns=1.1.1.1"]
  tags:
    - dind
    - linux  # Target Rocky Linux runner (excludes Darwin M1 which has 'darwin' tag)
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  dependencies:
    - container:build:amd64
  before_script:
    - |
      ATTEMPTS=0; MAX=30
      until docker info >/dev/null 2>&1; do
        ATTEMPTS=$((ATTEMPTS + 1))
        [ $ATTEMPTS -ge $MAX ] && echo "Docker not ready" && exit 1
        sleep 2
      done
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "ðŸŽ  Stage 2 - Complete validation with fresh container"
    - docker pull $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    - echo "Running comprehensive validation with fresh container..."
    - |
      docker run --rm -v "$(pwd)":/workspace \
        $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64 \
        validate --all --allow-warnings
    - echo "âœ… Stage 2 validation complete - No recursive validation issues!"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false

# Package stage jobs
package:python:
  stage: package
  image: python:3.11-alpine
  <<: *uv_setup
  cache:
    key:
      files:
        - pyproject.toml
        - uv.lock
      prefix: $CI_JOB_NAME
    paths:
      - .cache/uv
      - .cache/pip
      - .venv/
    policy: pull-push
  script:
    - uv sync --dev
    - uv build
    - mkdir -p artifacts/
    - cp dist/*.tar.gz dist/*.whl artifacts/ 2>/dev/null || true
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.whl
      - artifacts/
    expire_in: 1 month
    name: 'huskycat-python-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
  allow_failure: true  # Don't block binary tests if Python packaging fails

# NOTE: Binary build jobs are in .gitlab/ci/build.yml
# Supported platforms: linux-amd64, darwin-arm64
# See .gitlab/ci/build.yml for:
#   - build:binary:linux-amd64
#   - build:binary:darwin-arm64
# These jobs depend on download:tools:* jobs from .gitlab/ci/download-tools.yml

# macOS ARM64 (Apple Silicon) build with signing - uses GitLab SaaS macOS runners
# Required CI/CD Variables:
#   APPLE_CERTIFICATE_BASE64 - Base64 encoded .p12 certificate
#   APPLE_CERTIFICATE_PASSWORD - Certificate password
#   APPLE_DEVELOPER_ID_APPLICATION - "Developer ID Application: Your Name (TEAMID)"
#   APPLE_ID - Apple ID email for notarization
#   APPLE_NOTARIZE_PASSWORD - App-specific password for notarization
#   APPLE_TEAM_ID - Team ID
#
# NOTE: .macos_saas_runners template is defined in .gitlab/ci/macos-pkg.yml
# NOTE: sign:darwin-arm64 job is defined in .gitlab/ci/macos-pkg.yml
# NOTE: build:binary:darwin-arm64 job is defined in .gitlab/ci/build.yml

# Deploy stage jobs

# Upload binaries to GitLab Package Registry for private distribution
# Beta testers can download via deploy token without full repo access
publish:package-registry:
  stage: deploy
  image: curlimages/curl:latest
  needs:
    - job: build:binary:linux-amd64
      artifacts: true
    - job: build:binary:darwin-arm64
      artifacts: true
      optional: true
    - job: checksums:generate
      artifacts: true
  variables:
    PACKAGE_NAME: huskycat
    # Use tag version or commit SHA for non-tag builds
    PACKAGE_VERSION: "${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}"
  script:
    - echo "Publishing binaries to GitLab Package Registry..."
    - echo "Package version - ${PACKAGE_VERSION}"
    - 'test -f dist/bin/huskycat-linux-amd64 && curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file dist/bin/huskycat-linux-amd64 "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${PACKAGE_VERSION}/huskycat-linux-amd64" || echo "No linux binary"'
    - 'test -f dist/bin/huskycat-darwin-arm64 && curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file dist/bin/huskycat-darwin-arm64 "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${PACKAGE_VERSION}/huskycat-darwin-arm64" || echo "No darwin binary"'
    - 'test -f dist/bin/SHA256SUMS.txt && curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file dist/bin/SHA256SUMS.txt "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${PACKAGE_VERSION}/SHA256SUMS.txt" || echo "No checksums"'
    - echo "Package registry upload complete!"
    - echo "Download URLs (requires deploy token or project access)"
    - echo "Linux - ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${PACKAGE_VERSION}/huskycat-linux-amd64"
    - echo "macOS - ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${PACKAGE_VERSION}/huskycat-darwin-arm64"
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"

release:create:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: package:python
      optional: true
    - job: build:binary:linux-amd64
      optional: true
    - job: sign:darwin-arm64
      optional: true
    - job: checksums:generate
      optional: true
  script:
    - |
      release-cli create \
        --name "HuskyCat $CI_COMMIT_TAG" \
        --tag-name $CI_COMMIT_TAG \
        --description "Release $CI_COMMIT_TAG of HuskyCat Universal Code Validation Platform - Fat binaries with embedded validation tools" \
        --assets-link "{\"name\":\"Linux AMD64 Binary (Fat)\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-linux-amd64?job=build:binary:linux-amd64\"}" \
        --assets-link "{\"name\":\"macOS ARM64 Binary (Apple Silicon - Signed, Fat)\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-darwin-arm64?job=sign:darwin-arm64\"}" \
        --assets-link "{\"name\":\"SHA256 Checksums\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/SHA256SUMS.txt?job=checksums:generate\"}" \
        --assets-link "{\"name\":\"Python Wheel Package\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/browse/dist?job=package:python\"}" \
        --assets-link "{\"name\":\"Container Image\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/container_registry/$CI_COMMIT_TAG\"}" \
        --assets-link "{\"name\":\"Documentation\",\"url\":\"https://tinyland.gitlab.io/ai/huskycat/\"}"
  rules:
    - if: $CI_COMMIT_TAG
# Security scanning jobs (using GitLab security templates)
# These are automatically included via the templates at the top
# Runner tags fixed - all runners now properly tagged
