# HuskyCat GitLab CI/CD Pipeline
# Production-ready pipeline with comprehensive validation, multi-architecture builds, and security scanning

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - local: '/.gitlab/ci/scheduled-updates.yml'
  - local: '/.gitlab/ci/pages.yml'
  - local: '/.gitlab/ci/e2e-tests.yml'
  - local: '/.gitlab/ci/download-tools.yml'
  - local: '/.gitlab/ci/build.yml'

stages:
  - validate
  - security
  - build  # Tool downloads happen here
  - test
  - package  # Binary builds happen here (depends on build stage)
  - sign
  - deploy
  - scheduled

variables:
  CONTAINER_REGISTRY: registry.gitlab.com/tinyland/ai/huskycat
  CONTAINER_TAG: $CI_COMMIT_SHORT_SHA
  UV_CACHE_DIR: $CI_PROJECT_DIR/.cache/uv
  PIP_CACHE_DIR: $CI_PROJECT_DIR/.cache/pip
  UV_VERSION: '0.5.8'
  PAGES_URL: https://huskycat-570fbd.gitlab.io
  BUILDAH_FORMAT: docker
  BUILDAH_ISOLATION: chroot
  # Security scanning variables
  SAST_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'
  DS_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'

# Global cache configuration - inline for package:python job

.uv_setup: &uv_setup
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version

# Container-based validation (after container build for parity)
validate:basic:
  stage: security
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  script:
    - echo "üê≥ Using HuskyCat container for validation parity"
    - which black && black --version
    - black --check src/
    - echo "‚úÖ Basic validation complete using container tools"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# MkDocs validation removed - handled by mkdocs:build job for Pages deployment

validate:yaml:
  stage: security
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  script:
    - echo "üê≥ Using HuskyCat container for YAML validation parity"
    - which yamllint && yamllint --version
    - yamllint .gitlab-ci.yml mkdocs.yml
    - find . -name "*.yml" -o -name "*.yaml" | grep -v .cache | xargs yamllint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Test stage jobs
test:unit:
  stage: test
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "üê≥ Using HuskyCat container with pre-installed tools"
    - which python3 && python3 --version
    - which pytest && pytest --version
    - pwd && ls -la
    - export HYPOTHESIS_PROFILE=ci
    - 'echo "Using Hypothesis profile: $HYPOTHESIS_PROFILE"'
    - pytest tests/test_*pbt.py -v --tb=short --hypothesis-profile=ci --timeout=300 --cov=src/
  coverage: '/TOTAL.*\s+(\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# E2E tests removed - tracked as future goals in docs/future-roadmap.md
# Previously included test:e2e:comprehensive, test:e2e:playwright, and test:e2e:deployment jobs
# These tested GitLab Pages deployment and MCP integration but were aspirational

test:mcp:server:
  stage: test
  image:
    name: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    entrypoint: [""]
  needs:
    - container:build:amd64
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "üê≥ Using HuskyCat container with pre-installed tools"
    - which python3 && python3 --version
    - which pytest && pytest --version
    - pwd && ls -la
    - pytest tests/test_mcp_server_pbt.py -v --tb=short
  artifacts:
    when: on_failure
    paths:
      - logs/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Build stage jobs - multi-architecture container builds
.container_build_template: &container_build_template
  stage: validate
  image: quay.io/buildah/stable:latest
  before_script:
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  after_script:
    - buildah logout $CI_REGISTRY

container:build:amd64:
  <<: *container_build_template
  variables:
    PLATFORM: linux/amd64
    ARCH: amd64
  script:
    - echo "Building container for $PLATFORM with layer caching..."
    - buildah build --platform=$PLATFORM --layers -f ContainerFile -t $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH .
    - buildah push $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

container:build:arm64:
  <<: *container_build_template
  variables:
    PLATFORM: linux/arm64
    ARCH: arm64
  script:
    - echo "Building container for $PLATFORM with layer caching..."
    - buildah build --platform=$PLATFORM --layers -f ContainerFile -t $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH .
    - buildah push $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

container:build:manifest:
  stage: build
  image: quay.io/buildah/stable:latest
  dependencies:
    - container:build:amd64
    - container:build:arm64
  before_script:
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Create multi-arch manifest for commit tag
    - buildah manifest create $CONTAINER_REGISTRY:$CONTAINER_TAG
    - buildah manifest add $CONTAINER_REGISTRY:$CONTAINER_TAG $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    - buildah manifest add $CONTAINER_REGISTRY:$CONTAINER_TAG $CONTAINER_REGISTRY:$CONTAINER_TAG-arm64
    - buildah manifest push --all $CONTAINER_REGISTRY:$CONTAINER_TAG
    # Create multi-arch manifest for latest tag (main branch only)
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ -n "$CI_COMMIT_TAG" ]; then
        buildah manifest create $CONTAINER_REGISTRY:latest
        buildah manifest add $CONTAINER_REGISTRY:latest $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
        buildah manifest add $CONTAINER_REGISTRY:latest $CONTAINER_REGISTRY:$CONTAINER_TAG-arm64
        buildah manifest push --all $CONTAINER_REGISTRY:latest
      fi
  after_script:
    - buildah logout $CI_REGISTRY
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# NOTE: container:build:dev job removed - ContainerFile.dev does not exist
# To re-enable, create ContainerFile.dev with development tools

# Stage 2: Complete validation using freshly built container
validate:complete:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  dependencies:
    - container:build:amd64
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üé† Stage 2 - Complete validation with fresh container"
    - docker pull $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    - echo "Running comprehensive validation with fresh container..."
    - |
      docker run --rm -v "$(pwd)":/workspace \
        $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64 \
        validate --all --allow-warnings
    - echo "‚úÖ Stage 2 validation complete - No recursive validation issues!"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false

# Package stage jobs
package:python:
  stage: package
  image: python:3.11-alpine
  <<: *uv_setup
  cache:
    key:
      files:
        - pyproject.toml
        - uv.lock
      prefix: $CI_JOB_NAME
    paths:
      - .cache/uv
      - .cache/pip
      - .venv/
    policy: pull-push
  script:
    - uv sync --dev
    - uv build
    - mkdir -p artifacts/
    - cp dist/*.tar.gz dist/*.whl artifacts/ 2>/dev/null || true
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.whl
      - artifacts/
    expire_in: 1 month
    name: 'huskycat-python-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# NOTE: Old binary build jobs moved to .gitlab/ci/build.yml
# New fat binary builds include embedded validation tools
# See .gitlab/ci/build.yml for:
#   - build:binary:linux-amd64
#   - build:binary:linux-arm64
#   - build:binary:darwin-arm64
# These jobs depend on download:tools:* jobs from .gitlab/ci/download-tools.yml

# Old binary:build:linux job (replaced by build:binary:linux-amd64 in build.yml)
# binary:build:linux:
#   stage: package
#   ...

# Old binary:build:linux-arm64 job (replaced by build:binary:linux-arm64 in build.yml)
# binary:build:linux-arm64:
#   stage: package
#   ...

# macOS ARM64 (Apple Silicon) build with signing - uses GitLab SaaS macOS runners
# Required CI/CD Variables:
#   APPLE_CERTIFICATE_BASE64 - Base64 encoded .p12 certificate
#   APPLE_CERTIFICATE_PASSWORD - Certificate password
#   APPLE_DEVELOPER_ID_APPLICATION - "Developer ID Application: Your Name (TEAMID)"
#   APPLE_ID - Apple ID email for notarization
#   APPLE_NOTARIZE_PASSWORD - App-specific password for notarization
#   APPLE_TEAM_ID - Team ID
.macos_saas_runners:
  tags:
    - saas-macos-medium-m1
  image: macos-14-xcode-15

# Old binary:build:darwin-arm64 job (replaced by build:binary:darwin-arm64 in build.yml)
# The new version includes embedded validation tools
# binary:build:darwin-arm64:
#   extends: .macos_saas_runners
#   stage: package
#   ...

# Darwin Code Signing (requires APPLE_* variables in CI settings)
# Follows crush's proven temporary keychain pattern
sign:darwin-arm64:
  extends: .macos_saas_runners
  stage: sign
  needs:
    - job: build:binary:darwin-arm64
      artifacts: true
  script:
    - echo "Checking for code signing certificate..."
    - |
      if [ -n "$APPLE_CERTIFICATE_BASE64" ]; then
        # Full Developer ID signing
        echo "Using Developer ID certificate for signing..."
        echo "$APPLE_CERTIFICATE_BASE64" | base64 -d > certificate.p12

        # ========================================================================
        # TEMPORARY KEYCHAIN WITH CI BEST PRACTICES
        # ========================================================================
        # Research Findings Summary:
        #
        # After extensive research, the solution requires creating a TEMPORARY keychain with
        # proper configuration for headless CI environments. Key requirements discovered:
        #
        # 1. Medium - Build System Keychains: Comprehensive guide on temporary keychain setup
        #    for CI/CD with proper partition list configuration
        #    Source: https://byteable.medium.com/creating-a-temporary-keychain-for-your-build-system-e598628c65bd
        #
        # 2. Apple Developer Forums - Partition Lists: The -s flag in set-key-partition-list
        #    is CRITICAL for headless environments to avoid user interaction prompts
        #    Source: https://developer.apple.com/forums/thread/666107
        #
        # 3. GitHub gon - Manual Keychain Approvals: Partition list must include "apple:"
        #    for signing tools to access private keys without user approval
        #    Source: https://github.com/mitchellh/gon/issues/39
        #
        # 4. CircleCI Discussion: "For Developer ID signing, you need to install Developer ID G1/G2
        #    certificates and not Worldwide Developer Relations as typically expected."
        #    Source: https://discuss.circleci.com/t/cssmerr-tp-not-trusted-for-developer-id-certificate/49911
        #
        # 5. macOS 14.6.1 Security: Stricter launch constraints vs macOS 15.6 (local dev)
        #    Source: https://eclecticlight.co/2024/09/03/launching-apps-in-sonoma-14-6-1-conclusions/
        #
        # Critical Configuration:
        # - Create temporary keychain with strong password
        # - Disable lock timeout and auto-lock on sleep
        # - Add to keychain search list BEFORE SystemRootCertificates
        # - Use set-key-partition-list with -s flag and "apple:" in partition list
        # - Import only correct intermediate certificates (Developer ID G2, NOT WWDR G2)
        # ========================================================================

        echo "=== Creating temporary keychain with CI best practices ==="
        KEYCHAIN_NAME="signing.keychain-db"
        KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

        # Create keychain with password (required for security set-key-partition-list)
        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

        # Configure keychain for CI: no timeout, no auto-lock
        # Reference: https://byteable.medium.com/creating-a-temporary-keychain-for-your-build-system-e598628c65bd
        security set-keychain-settings "$KEYCHAIN_NAME"

        # Unlock keychain
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

        # Set as default keychain for this session
        security default-keychain -s "$KEYCHAIN_NAME"

        # Add to search list with SystemRootCertificates for trust chain validation
        # CRITICAL: Our keychain MUST come before SystemRootCertificates in the search order
        echo "=== Checking SystemRootCertificates.keychain exists ==="
        ls -la /System/Library/Keychains/SystemRootCertificates.keychain || echo "NOT FOUND!"

        # Get login keychain path for search list
        LOGIN_KEYCHAIN="$HOME/Library/Keychains/login.keychain-db"

        echo "=== Setting keychain search list with login keychain ==="
        # CRITICAL: Include login keychain in search list as many CI solutions require it
        # Research indicates intermediates may need to be findable in login keychain
        # Reference: https://discuss.circleci.com/t/cssmerr-tp-not-trusted-for-developer-id-certificate/49911
        security list-keychains -d user -s "$KEYCHAIN_NAME" "$LOGIN_KEYCHAIN" /System/Library/Keychains/SystemRootCertificates.keychain

        echo "=== Current keychain search list ==="
        security list-keychains -d user

        # NOTE: Do NOT import Apple Root CA to the system keychain!
        # The security framework uses SystemRootCertificates for trust anchors.
        # Importing a copy creates an untrusted duplicate that causes CSSMERR_TP_NOT_TRUSTED.
        # Only import the intermediate certs which are NOT in SystemRootCertificates.

        # Import ONLY Developer ID Certification Authority G2 intermediate
        # DO NOT import Apple WWDR CA - G2 - it chains to the wrong root (G3 instead of original)!
        # Reference: https://discuss.circleci.com/t/cssmerr-tp-not-trusted-for-developer-id-certificate/49911
        if [ -n "$APPLE_DEVELOPER_ID_CA_G2" ]; then
          echo "Importing Developer ID Certification Authority G2 intermediate..."
          echo "$APPLE_DEVELOPER_ID_CA_G2" | base64 -d > DeveloperIDG2CA.cer

          # Import to our signing keychain
          security import DeveloperIDG2CA.cer -k "$KEYCHAIN_NAME" -T /usr/bin/codesign -T /usr/bin/productsign -T /usr/bin/pkgbuild -A 2>&1 || true

          # ALSO import to login keychain - research indicates this may be required for trust validation
          # Reference: https://discuss.circleci.com/t/cssmerr-tp-not-trusted-for-developer-id-certificate/49911/2
          echo "Also importing G2 intermediate to login keychain for trust validation..."
          security import DeveloperIDG2CA.cer -k "$LOGIN_KEYCHAIN" -T /usr/bin/codesign -T /usr/bin/productsign -T /usr/bin/pkgbuild -A 2>&1 || true

          echo "Developer ID CA G2 intermediate imported to both keychains"
        fi

        # Import Application certificate
        echo "Importing Developer ID Application certificate..."
        security import certificate.p12 -k "$KEYCHAIN_NAME" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -A

        # Set partition list to allow command-line access without user interaction
        # CRITICAL: The -s flag and password are required for headless CI environments
        # The partition list MUST include "apple:" for signing tools to access private keys
        # Reference: https://developer.apple.com/forums/thread/666107
        # Reference: https://github.com/mitchellh/gon/issues/39
        # Reference: https://byteable.medium.com/creating-a-temporary-keychain-for-your-build-system-e598628c65bd
        echo "Setting partition list for headless CI access..."
        security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

        # Verify signing identities are available
        echo "=== Signing identities ==="
        security find-identity -v "$KEYCHAIN_NAME"

        # Check if we have an Application certificate (not just Installer)
        APP_CERT_COUNT=$(security find-identity -v "$KEYCHAIN_NAME" | grep -c "Developer ID Application" || true)
        if [ "$APP_CERT_COUNT" -eq 0 ]; then
          echo "WARNING: No Developer ID Application certificate found"
          echo "Certificate imported is Developer ID Installer (for PKG signing)"
          echo "Falling back to ad-hoc signing for binary..."
          codesign --force --sign - dist/bin/huskycat-darwin-arm64
          codesign --verify --verbose dist/bin/huskycat-darwin-arm64
          echo "Binary ad-hoc signed (suitable for testing, not App Store/notarization)"
        else
          # Sign the binary with Developer ID Application
          echo "Signing HuskyCat binary with Developer ID Application..."
          codesign --force --options runtime --sign "$APPLE_DEVELOPER_ID_APPLICATION" --keychain "$KEYCHAIN_NAME" dist/bin/huskycat-darwin-arm64
          codesign --verify --verbose dist/bin/huskycat-darwin-arm64
          echo "Binary signed with Developer ID"
        fi

        # Notarize if credentials available and we used Developer ID signing (not ad-hoc)
        if [ "$APP_CERT_COUNT" -gt 0 ] && [ -n "$APPLE_ID" ] && [ -n "$APPLE_NOTARIZE_PASSWORD" ] && [ -n "$APPLE_TEAM_ID" ]; then
          echo "Notarizing binary..."

          # Create a zip for notarization
          ditto -c -k --keepParent dist/bin/huskycat-darwin-arm64 huskycat-darwin-arm64.zip

          SUBMISSION_OUTPUT=$(xcrun notarytool submit huskycat-darwin-arm64.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_NOTARIZE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait 2>&1)
          echo "$SUBMISSION_OUTPUT"

          # Extract submission ID and check status
          SUBMISSION_ID=$(echo "$SUBMISSION_OUTPUT" | grep "id:" | head -1 | awk '{print $2}')
          if echo "$SUBMISSION_OUTPUT" | grep -q "status: Invalid"; then
            echo "Notarization failed! Fetching log for details..."
            xcrun notarytool log "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_NOTARIZE_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              notarization-log.json
            cat notarization-log.json
            exit 1
          fi

          echo "Binary notarized successfully"
          rm huskycat-darwin-arm64.zip
        else
          echo "Notarization skipped - set APPLE_ID, APPLE_NOTARIZE_PASSWORD, APPLE_TEAM_ID"
        fi
      else
        # Ad-hoc signing (self-signed) - works without Apple Developer account
        echo "No Developer ID certificate - using ad-hoc signing..."
        codesign --force --sign - dist/bin/huskycat-darwin-arm64
        codesign --verify --verbose dist/bin/huskycat-darwin-arm64
        echo "Binary ad-hoc signed (suitable for testing, not App Store/notarization)"
      fi
    # Archive signed binary
    - tar -czf huskycat-darwin-arm64-signed.tar.gz -C dist/bin huskycat-darwin-arm64
    - shasum -a 256 huskycat-darwin-arm64-signed.tar.gz > huskycat-darwin-arm64-signed.sha256
    - cat huskycat-darwin-arm64-signed.sha256
  artifacts:
    paths:
      - huskycat-darwin-arm64-signed.tar.gz
      - huskycat-darwin-arm64-signed.sha256
      - dist/bin/huskycat-darwin-arm64
    expire_in: 1 month
    when: on_success
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
  allow_failure: true  # Don't block pipeline if signing not configured

# Deploy stage jobs
# NOTE: macOS AMD64 (Intel) builds removed - GitLab SaaS only provides ARM64 runners
release:create:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: package:python
      optional: true
    - job: build:binary:linux-amd64
      optional: true
    - job: build:binary:linux-arm64
      optional: true
    - job: sign:darwin-arm64
      optional: true
    - job: checksums:generate
      optional: true
  script:
    - |
      release-cli create \
        --name "HuskyCat $CI_COMMIT_TAG" \
        --tag-name $CI_COMMIT_TAG \
        --description "Release $CI_COMMIT_TAG of HuskyCat Universal Code Validation Platform - Fat binaries with embedded validation tools" \
        --assets-link "{\"name\":\"Linux AMD64 Binary (Fat)\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-linux-amd64?job=build:binary:linux-amd64\"}" \
        --assets-link "{\"name\":\"Linux ARM64 Binary (Fat)\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-linux-arm64?job=build:binary:linux-arm64\"}" \
        --assets-link "{\"name\":\"macOS ARM64 Binary (Apple Silicon - Signed, Fat)\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-darwin-arm64?job=sign:darwin-arm64\"}" \
        --assets-link "{\"name\":\"SHA256 Checksums\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/SHA256SUMS.txt?job=checksums:generate\"}" \
        --assets-link "{\"name\":\"Python Wheel Package\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/browse/dist?job=package:python\"}" \
        --assets-link "{\"name\":\"Container Image\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/container_registry/$CI_COMMIT_TAG\"}" \
        --assets-link "{\"name\":\"Documentation\",\"url\":\"https://tinyland.gitlab.io/ai/huskycat/\"}"
  rules:
    - if: $CI_COMMIT_TAG
# Security scanning jobs (using GitLab security templates)
# These are automatically included via the templates at the top
