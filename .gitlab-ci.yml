# HuskyCat GitLab CI/CD Pipeline
# Production-ready pipeline with comprehensive validation, multi-architecture builds, and security scanning

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - local: '/.gitlab/ci/scheduled-updates.yml'
  - local: '/.gitlab/ci/pages.yml'

stages:
  - validate
  - security
  - test
  - build
  - package
  - deploy
  - scheduled

variables:
  CONTAINER_REGISTRY: registry.gitlab.com/tinyland/ai/huskycat
  CONTAINER_TAG: $CI_COMMIT_SHORT_SHA
  UV_CACHE_DIR: $CI_PROJECT_DIR/.cache/uv
  PIP_CACHE_DIR: $CI_PROJECT_DIR/.cache/pip
  UV_VERSION: '0.5.8'
  PAGES_URL: https://tinyland.gitlab.io/ai/huskycat
  BUILDAH_FORMAT: docker
  BUILDAH_ISOLATION: chroot
  # Security scanning variables
  SAST_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'
  DS_EXCLUDED_PATHS: 'spec, test, tests, tmp, .cache, .hypothesis'

# Global cache configuration
.cache_template: &cache_template
  cache:
    key:
      files:
        - pyproject.toml
        - uv.lock
      prefix: $CI_JOB_NAME
    paths:
      - .cache/uv
      - .cache/pip
      - .venv/
    policy: pull-push

.uv_setup: &uv_setup
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version

# Stage 1: Basic validation (before container build)
validate:basic:
  stage: validate
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --dev
    - echo "üöÄ Stage 1 - Basic validation (pre-container)"
    - uv run black --check src/
    - echo "‚úì Stage 1 - Basic validation complete (flake8 temporarily disabled for demo)"
    - echo "‚úÖ Stage 1 validation complete"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

mkdocs:validate:
  stage: validate
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --extra docs
    - uv run mkdocs build --strict --verbose --site-dir .tmp/site
  artifacts:
    when: on_failure
    paths:
      - .tmp/site/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

validate:yaml:
  stage: validate
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --dev
    - uv run yamllint .gitlab-ci.yml mkdocs.yml
    - find . -name "*.yml" -o -name "*.yaml" | grep -v .cache | xargs uv run yamllint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Test stage jobs
test:unit:
  stage: test
  image: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
  dependencies:
    - container:build:amd64
  script:
    - echo "üê≥ Using HuskyCat container with pre-installed tools"
    - which python3 && python3 --version
    - which pytest && pytest --version
    - cd /workspace
    - pytest tests/test_validation_pbt.py tests/test_unified_validation_pbt.py -v --tb=short --cov=src/ --cov-report=xml --cov-report=html --cov-report=term
  coverage: '/TOTAL.*\s+(\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

test:e2e:deployment:
  stage: test
  image: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
  dependencies:
    - container:build:amd64
  script:
    - echo "üê≥ Using HuskyCat container for E2E deployment testing"
    - cd /workspace
    - python3 tests/test_e2e_deployment.py
  artifacts:
    when: on_failure
    paths:
      - logs/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

test:e2e:comprehensive:
  stage: test
  image: mcr.microsoft.com/playwright/python:v1.40.0-focal
  variables:
    PLAYWRIGHT_BROWSERS_PATH: /ms-playwright
  before_script:
    - apt-get update && apt-get install -y python3-pip curl
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
  script:
    - uv sync --dev
    - playwright install chromium
    - uv run python tests/e2e/run_e2e_tests.py --suite=all --skip-slow --headless
  artifacts:
    when: always
    paths:
      - reports/
      - test-results/
      - playwright-report/
    reports:
      junit:
        - reports/e2e-full-junit.xml
        - reports/playwright-results.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

test:e2e:playwright:
  stage: test
  image: mcr.microsoft.com/playwright/python:v1.40.0-focal
  variables:
    PLAYWRIGHT_BROWSERS_PATH: /ms-playwright
  before_script:
    - apt-get update && apt-get install -y python3-pip curl
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
  script:
    - uv sync --dev
    - playwright install chromium firefox
    - uv run python tests/e2e/run_e2e_tests.py --suite=playwright --headless --browser=chromium
  artifacts:
    when: always
    paths:
      - reports/playwright-report.html
      - playwright-report/
      - test-results/
    reports:
      junit: reports/playwright-junit.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

test:mcp:server:
  stage: test
  image: $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
  dependencies:
    - container:build:amd64
  script:
    - echo "üê≥ Using HuskyCat container with pre-installed tools"
    - which python3 && python3 --version
    - which pytest && pytest --version
    - cd /workspace
    - pytest tests/test_mcp_server_pbt.py -v --tb=short
  artifacts:
    when: on_failure
    paths:
      - logs/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

mkdocs:build:
  stage: test
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --extra docs
    - uv run mkdocs build --verbose --site-dir public
  artifacts:
    paths:
      - public/
    expire_in: 1 week
    name: 'mkdocs-site-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Build stage jobs - multi-architecture container builds
.container_build_template: &container_build_template
  stage: security
  image: quay.io/buildah/stable:latest
  before_script:
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  after_script:
    - buildah logout $CI_REGISTRY

container:build:amd64:
  <<: *container_build_template
  variables:
    PLATFORM: linux/amd64
    ARCH: amd64
  script:
    - buildah build --platform=$PLATFORM -f ContainerFile -t $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH .
    - buildah push $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

container:build:arm64:
  <<: *container_build_template
  variables:
    PLATFORM: linux/arm64
    ARCH: arm64
  script:
    - buildah build --platform=$PLATFORM -f ContainerFile -t $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH .
    - buildah push $CONTAINER_REGISTRY:$CONTAINER_TAG-$ARCH
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

container:build:manifest:
  stage: build
  image: quay.io/buildah/stable:latest
  dependencies:
    - container:build:amd64
    - container:build:arm64
  before_script:
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Create multi-arch manifest for commit tag
    - buildah manifest create $CONTAINER_REGISTRY:$CONTAINER_TAG
    - buildah manifest add $CONTAINER_REGISTRY:$CONTAINER_TAG $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    - buildah manifest add $CONTAINER_REGISTRY:$CONTAINER_TAG $CONTAINER_REGISTRY:$CONTAINER_TAG-arm64
    - buildah manifest push --all $CONTAINER_REGISTRY:$CONTAINER_TAG
    # Create multi-arch manifest for latest tag (main branch only)
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ -n "$CI_COMMIT_TAG" ]; then
        buildah manifest create $CONTAINER_REGISTRY:latest
        buildah manifest add $CONTAINER_REGISTRY:latest $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
        buildah manifest add $CONTAINER_REGISTRY:latest $CONTAINER_REGISTRY:$CONTAINER_TAG-arm64
        buildah manifest push --all $CONTAINER_REGISTRY:latest
      fi
  after_script:
    - buildah logout $CI_REGISTRY
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

container:build:dev:
  <<: *container_build_template
  script:
    - buildah build -f ContainerFile.dev -t $CONTAINER_REGISTRY:dev-$CONTAINER_TAG .
    - buildah build -f ContainerFile.dev -t $CONTAINER_REGISTRY:dev-latest .
    - buildah push $CONTAINER_REGISTRY:dev-$CONTAINER_TAG
    - buildah push $CONTAINER_REGISTRY:dev-latest
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/

# Stage 2: Complete validation using freshly built container
validate:complete:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  dependencies:
    - container:build:amd64
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üé† Stage 2 - Complete validation with fresh container"
    - docker pull $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64
    - echo "Running comprehensive validation with fresh container..."
    - |
      docker run --rm -v "$(pwd)":/workspace \
        $CONTAINER_REGISTRY:$CONTAINER_TAG-amd64 \
        validate --all --allow-warnings
    - echo "‚úÖ Stage 2 validation complete - No recursive validation issues!"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false

# Package stage jobs
package:python:
  stage: package
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  script:
    - uv sync --dev
    - uv build
    - mkdir -p artifacts/
    - cp dist/*.tar.gz dist/*.whl artifacts/ 2>/dev/null || true
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.whl
      - artifacts/
    expire_in: 1 month
    name: 'huskycat-python-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

binary:build:linux:
  stage: package
  image: python:3.11-alpine
  <<: *uv_setup
  <<: *cache_template
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev upx binutils zlib-dev
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
  script:
    - uv sync --extra build
    - mkdir -p dist/bin
    - uv run pyinstaller --onefile --name huskycat-linux-amd64 src/__main__.py
    - mv dist/huskycat-linux-amd64 dist/bin/
    - chmod +x dist/bin/huskycat-linux-amd64
    - upx --best --lzma dist/bin/huskycat-linux-amd64 || echo "UPX compression failed, continuing without compression"
    - ls -la dist/bin/
    - file dist/bin/huskycat-linux-amd64
    - dist/bin/huskycat-linux-amd64 --version || echo "Binary test failed, but continuing"
  artifacts:
    paths:
      - dist/bin/huskycat-linux-amd64
    expire_in: 1 month
    name: 'huskycat-linux-binary-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

binary:build:macos:
  stage: package
  # This job requires a macOS runner with Xcode Command Line Tools
  tags:
    - macos  # Requires a GitLab runner with this tag on macOS
  variables:
    # macOS signing variables - set in GitLab CI/CD variables
    APPLE_SIGNING_IDENTITY: $APPLE_SIGNING_IDENTITY  # e.g., "Developer ID Application: Your Name (TEAM_ID)"
    APPLE_TEAM_ID: $APPLE_TEAM_ID
    KEYCHAIN_PATH: $HOME/Library/Keychains/login.keychain-db
  before_script:
    # Install UV (Python package manager)
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
    # Setup Python environment
    - uv sync --extra build
    # Verify code signing tools are available
    - which codesign
    - security find-identity -v -p codesigning || echo "No signing identities found"
    # Import signing certificate from CI variables if provided
    - |
      if [ -n "$APPLE_CERTIFICATE_P12_BASE64" ] && [ -n "$APPLE_CERTIFICATE_PASSWORD" ]; then
        echo "üîê Importing signing certificate..."
        echo "$APPLE_CERTIFICATE_P12_BASE64" | base64 -D > certificate.p12
        # Create temporary keychain for CI
        security create-keychain -p "$KEYCHAIN_PASSWORD" ci.keychain
        security default-keychain -s ci.keychain
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" ci.keychain
        security import certificate.p12 -k ci.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -A
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" ci.keychain
        rm certificate.p12
        echo "‚úÖ Certificate imported successfully"
      else
        echo "‚ÑπÔ∏è  No certificate provided - will use ad-hoc signing"
      fi
  script:
    - mkdir -p dist/bin
    # Build binary with appropriate signing
    - |
      if [ -n "$APPLE_SIGNING_IDENTITY" ]; then
        echo "üîê Building signed macOS binary..."
        uv run python build_binary.py \
          --codesign-identity "$APPLE_SIGNING_IDENTITY" \
          --entitlements-file entitlements.plist \
          --skip-upx
      else
        echo "‚ÑπÔ∏è  Building unsigned macOS binary..."
        uv run python build_binary.py \
          --skip-upx
      fi
    # Move and rename binary
    - mv dist/huskycat dist/bin/huskycat-macos-arm64
    - chmod +x dist/bin/huskycat-macos-arm64
    # Verify binary
    - file dist/bin/huskycat-macos-arm64
    - dist/bin/huskycat-macos-arm64 --version
    # Check code signing status
    - codesign -dv dist/bin/huskycat-macos-arm64 || echo "Binary verification failed"
    - ls -la dist/bin/
  after_script:
    # Clean up keychain if created
    - |
      if [ -f ci.keychain ]; then
        security delete-keychain ci.keychain || true
      fi
  artifacts:
    paths:
      - dist/bin/huskycat-macos-arm64
    expire_in: 1 month
    name: 'huskycat-macos-binary-$CI_COMMIT_SHORT_SHA'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    # Allow manual triggering for testing
    - when: manual
      allow_failure: true

# Deploy stage jobs
release:create:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  dependencies:
    - package:python
    - binary:build:linux
  script:
    - |
      release-cli create \
        --name "HuskyCat $CI_COMMIT_TAG" \
        --tag-name $CI_COMMIT_TAG \
        --description "Release $CI_COMMIT_TAG of HuskyCat Universal Code Validation Platform" \
        --assets-link "{\"name\":\"Linux AMD64 Binary\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/bin/huskycat-linux-amd64?job=binary:build:linux\"}" \
        --assets-link "{\"name\":\"Python Wheel Package\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/-/jobs/artifacts/$CI_COMMIT_TAG/browse/dist?job=package:python\"}" \
        --assets-link "{\"name\":\"Container Image\",\"url\":\"https://gitlab.com/tinyland/ai/huskycat/container_registry/$CI_COMMIT_TAG\"}" \
        --assets-link "{\"name\":\"Documentation\",\"url\":\"https://tinyland.gitlab.io/ai/huskycat/\"}"
  rules:
    - if: $CI_COMMIT_TAG
# Security scanning jobs (using GitLab security templates)
# These are automatically included via the templates at the top
