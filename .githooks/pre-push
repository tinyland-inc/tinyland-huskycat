#!/usr/bin/env bash
# .githooks/pre-push - Fast pre-push validation using HuskyCat
#
# PARADIGM: Eat your own dogfood - uses HuskyCat's own validation engine
#
# REQUIREMENT: UV venv must be active for development in this repository.
#
# This hook is intentionally FAST - it only validates CI configuration.
# Full codebase validation happens in:
#   - pre-commit hook (staged files only)
#   - CI pipeline (full validation)
#
# Features:
#   - Uses HuskyCat ci-validate for GitLab CI configuration
#   - Skip hooks: SKIP_HOOKS=1 git push (or git push --no-verify)

set -euo pipefail

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source shared utilities
source "${SCRIPT_DIR}/_/common.sh"

# ============================================================================
# MAIN
# ============================================================================

main() {
    log_header "HuskyCat Pre-Push Hook"

    # Check if hooks should be skipped
    if should_skip_hooks; then
        log_warn "Hooks skipped (SKIP_HOOKS=1)"
        exit 0
    fi

    # Verify UV environment is set up
    if ! verify_uv_environment; then
        log_error "UV environment not ready. Run: uv sync --dev"
        exit 1
    fi

    local exit_code=0

    # ------------------------------------------------------------------------
    # HUSKYCAT CI-VALIDATE (GitLab CI configuration only - FAST)
    # Full codebase validation is handled by pre-commit and CI pipeline
    # ------------------------------------------------------------------------
    if [[ -f ".gitlab-ci.yml" ]]; then
        log_step "Validating GitLab CI configuration..."

        set +e
        uv run python -m src.huskycat ci-validate .gitlab-ci.yml
        local ci_exit=$?
        set -e

        if [[ $ci_exit -ne 0 ]]; then
            log_error "GitLab CI configuration validation failed"
            exit_code=$ci_exit
        else
            log_info "CI configuration valid"
        fi
    else
        log_info "No .gitlab-ci.yml found, skipping CI validation"
    fi

    # ------------------------------------------------------------------------
    # SUMMARY
    # ------------------------------------------------------------------------
    if [[ $exit_code -eq 0 ]]; then
        log_header "Pre-Push Passed"
        log_info "CI config valid. Full validation will run in CI pipeline."
    else
        log_header "Pre-Push Failed"
        log_error "Fix issues above or use: SKIP_HOOKS=1 git push"
    fi

    exit $exit_code
}

# Run main
main "$@"
