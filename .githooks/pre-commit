#!/usr/bin/env bash
# .githooks/pre-commit - Validate staged files using HuskyCat
#
# PARADIGM: Eat your own dogfood - uses HuskyCat's own validation engine
#
# REQUIREMENT: UV venv must be active for development in this repository.
#
# Features:
#   - Uses HuskyCat validate command (not direct tool invocations)
#   - Interactive auto-fix prompts when issues found
#   - Auto-approve mode: HUSKYCAT_AUTO_APPROVE=1 or AUTO_FIX=1
#   - Skip hooks: SKIP_HOOKS=1 git commit (or git commit --no-verify)

set -euo pipefail

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source shared utilities
source "${SCRIPT_DIR}/_/common.sh"

# ============================================================================
# MAIN
# ============================================================================

main() {
    log_header "HuskyCat Pre-Commit Hook"

    # Check if hooks should be skipped
    if should_skip_hooks; then
        log_warn "Hooks skipped (SKIP_HOOKS=1)"
        exit 0
    fi

    # Verify UV environment is set up
    if ! verify_uv_environment; then
        log_error "UV environment not ready. Run: uv sync --dev"
        exit 1
    fi

    # Check for non-blocking mode configuration
    local nonblocking_mode
    nonblocking_mode=$(git config --get huskycat.nonblocking 2>/dev/null || echo "false")
    if [[ "$nonblocking_mode" == "true" ]]; then
        export HUSKYCAT_NONBLOCKING=1
        log_info "âš¡ Non-blocking validation mode enabled"
    fi

    # Get staged Python files (just to check if any exist)
    local staged_py
    staged_py=$(staged_files "py")

    if [[ -z "$staged_py" ]]; then
        log_info "No Python files staged, skipping validation"
        exit 0
    fi

    # Count staged files for display
    local file_count
    file_count=$(echo "$staged_py" | wc -l | tr -d ' ')
    log_step "Validating ${file_count} Python file(s) with HuskyCat..."

    # ------------------------------------------------------------------------
    # RUN HUSKYCAT VALIDATE
    # ------------------------------------------------------------------------
    local huskycat_args="--staged"

    if is_auto_approve; then
        huskycat_args="$huskycat_args --fix"
        log_info "Auto-fix mode enabled (HUSKYCAT_AUTO_APPROVE=1)"
    elif is_interactive; then
        huskycat_args="$huskycat_args --interactive"
    fi

    log_step "Running: uv run python -m src.huskycat validate $huskycat_args"

    # Check for non-blocking mode
    if [[ "$HUSKYCAT_NONBLOCKING" == "1" ]]; then
        # Non-blocking mode: fork and return immediately
        log_info "ðŸš€ Launching background validation..."
        uv run python -m src.huskycat validate $huskycat_args &
        local validate_pid=$!
        log_info "   Validation running in background (PID $validate_pid)"
        log_info "   Check results with: uv run python -m src.huskycat status"
        exit 0
    else
        # Blocking mode: wait for validation
        set +e
        uv run python -m src.huskycat validate $huskycat_args
        local exit_code=$?
        set -e

        if [[ $exit_code -ne 0 ]]; then
            log_error "HuskyCat validation failed (exit code: $exit_code)"

            # Check if files were modified (auto-fixed) and need to be re-staged
            local modified_staged
            modified_staged=$(git diff --name-only 2>/dev/null || true)

            if [[ -n "$modified_staged" ]]; then
                log_info "Re-staging fixed files..."
                echo "$modified_staged" | xargs -r git add
            fi

            echo ""
            echo "  To fix manually: uv run python -m src.huskycat validate --staged --fix"
            echo "  To skip hooks:   SKIP_HOOKS=1 git commit"
            echo ""
        fi
    fi

    # ------------------------------------------------------------------------
    # SUMMARY
    # ------------------------------------------------------------------------
    if [[ $exit_code -eq 0 ]]; then
        log_header "Pre-Commit Passed"
        log_info "All validations passed!"
    else
        log_header "Pre-Commit Failed"
        log_error "Fix issues above or use: SKIP_HOOKS=1 git commit"
    fi

    exit $exit_code
}

# Run main
main "$@"
