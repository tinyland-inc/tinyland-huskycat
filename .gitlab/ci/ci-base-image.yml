# CI Base Image Build
# Builds and publishes the HuskyCat CI base image with pre-installed UV and tools
# This image eliminates 2-5min of setup overhead in E2E tests and other CI jobs

# Build and push CI base image
# Runs weekly or on Containerfile changes to keep tools updated
build:ci-base-image:
  stage: build
  image: docker:25.0-cli
  services:
    - name: docker:25.0-dind
      command: ["--tls=false", "--dns=8.8.8.8", "--dns=1.1.1.1"]
  # No tags â€” uses shared runners (DinD via services)
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_BUILDKIT: "1"
    BASE_IMAGE_TAG: "registry.gitlab.com/tinyland/ai/huskycat-ci-base:latest"
  before_script:
    - |
      echo "Waiting for Docker daemon (max 60s)..."
      ATTEMPTS=0; MAX=30
      until docker info >/dev/null 2>&1; do
        ATTEMPTS=$((ATTEMPTS + 1))
        [ $ATTEMPTS -ge $MAX ] && echo "Docker not ready after 60s" && exit 1
        sleep 2
      done
      docker version
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building HuskyCat CI base image..."
    - |
      docker build \
        -f .gitlab/ci-images/Containerfile.ci-base \
        -t $BASE_IMAGE_TAG \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --cache-from $BASE_IMAGE_TAG \
        .
    - echo "Pushing CI base image to registry..."
    - docker push $BASE_IMAGE_TAG
    - 'echo "[OK] CI base image published: $BASE_IMAGE_TAG"'
    - 'echo "Size: $(docker images $BASE_IMAGE_TAG --format ''{{.Size}}'')"'
  rules:
    # Build on schedule (weekly refresh)
    - if: $CI_PIPELINE_SOURCE == "schedule"
    # Build when Containerfile or download script changes
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - .gitlab/ci-images/Containerfile.ci-base
        - scripts/download_tools.py
    # Manual trigger
    - if: $CI_PIPELINE_SOURCE == "web"
  allow_failure: false
  timeout: 30m
