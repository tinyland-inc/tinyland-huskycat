# HuskyCats Bates GitLab CI Template
# Include this in your .gitlab-ci.yml to enable comprehensive validation
#
# Usage:
# include:
#   - remote: 'https://gitlab.com/bates-ils/projects/trustees-portal/sid-controller/huskycats-bates/-/raw/main/.gitlab/ci/husky-validation.yml'

.husky:
  image:
    name: registry.gitlab.com/bates-ils/projects/trustees-portal/sid-controller/huskycats-bates/husky-lint:latest
    entrypoint: [""]  # Override entrypoint for CI commands
  variables:
    GIT_DEPTH: 0
  before_script:
    - echo "Running HuskyCats validation on $(uname -m)"
    - cd ${CI_PROJECT_DIR}

# Quick validation - runs all linters
husky:validate:
  extends: .husky
  stage: test
  script:
    - echo "üéØ Running HuskyCats comprehensive validation..."
    - chmod +x scripts/comprehensive-lint.sh || true
    - ./scripts/comprehensive-lint.sh || echo "Some linting issues found"
  allow_failure: true

# Python-specific validation
husky:python:
  extends: .husky
  stage: test
  script:
    - |
      if find . -name "*.py" -type f | grep -q .; then
        black --check .
        flake8 .
        mypy .
        ruff check .
        bandit -r .
      else
        echo "No Python files found"
      fi
  only:
    changes:
      - "**/*.py"
  allow_failure: true

# JavaScript/TypeScript validation
husky:javascript:
  extends: .husky
  stage: test
  script:
    - |
      if [ -f package.json ]; then
        npm ci || npm install
        npx eslint . || true
        npx prettier --check . || true
      else
        echo "No package.json found"
      fi
  only:
    changes:
      - "**/*.js"
      - "**/*.jsx"
      - "**/*.ts"
      - "**/*.tsx"
  allow_failure: true

# Security scanning
husky:security:
  extends: .husky
  stage: test
  script:
    - |
      # Scan for secrets
      patterns=(
        "password.*=.*['\"].*['\"]"
        "api[_-]?key.*=.*['\"].*['\"]"
        "secret.*=.*['\"].*['\"]"
        "token.*=.*['\"].*['\"]"
      )
      
      for pattern in "${patterns[@]}"; do
        if grep -r -i "$pattern" . --exclude-dir=.git --exclude-dir=node_modules 2>/dev/null | grep -v "example\|test\|mock"; then
          echo "‚ö†Ô∏è  Potential secret found!"
        fi
      done
  allow_failure: false

# Auto DevOps validation
husky:auto-devops:
  extends: .husky
  stage: test
  script:
    - |
      if [ -f scripts/auto-devops-validation.sh ]; then
        chmod +x scripts/auto-devops-validation.sh
        ./scripts/auto-devops-validation.sh || echo "Auto DevOps validation warnings"
      else
        echo "Auto DevOps validation script not found"
      fi
  only:
    changes:
      - .gitlab-ci.yml
      - values*.yaml
      - .helm/**/*
      - k8s/**/*
  allow_failure: true