# E2E Tests for HuskyCat Bootstrap and Git Hooks
# Tests the complete binary + git hooks workflow for GitOps repositories
#
# Optimization: Uses `changes:` rules for incremental test selection
# Only runs tests when relevant files change (similar to Bazel's incremental behavior)

# Template for E2E test retry logic
.e2e_retry_transient: &e2e_retry
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# E2E: Test bootstrap on full GitOps repository
test:e2e:bootstrap:gitops:
  stage: test
  image: python:3.11-alpine
  <<: *e2e_retry
  needs: []  # Start immediately, don't wait for container build
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev linux-headers
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
    - git config --global user.name "CI Test"
    - git config --global user.email "ci@test.com"
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "=== E2E Test - Bootstrap on GitOps Repository ==="
    - uv sync --dev
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapGitOps::test_bootstrap_full_gitops_repo -v -s
  artifacts:
    when: on_failure
    paths:
      - pytest-logs/
    expire_in: 1 week
  rules:
    # Run on bootstrap/hook changes
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - src/huskycat/commands/bootstrap.py
        - src/huskycat/hooks/**/*.py
        - tests/e2e/**/*.py
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - src/huskycat/commands/bootstrap.py
        - src/huskycat/hooks/**/*.py
        - tests/e2e/**/*.py

# E2E: Test bootstrap on different repository types
test:e2e:bootstrap:types:
  stage: test
  image: python:3.11-alpine
  <<: *e2e_retry
  needs: []
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev linux-headers
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
    - git config --global user.name "CI Test"
    - git config --global user.email "ci@test.com"
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "=== E2E Test - Bootstrap on Different Repository Types ==="
    - uv sync --dev
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapGitOps::test_bootstrap_helm_only_repo -v -s
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapGitOps::test_bootstrap_k8s_only_repo -v -s
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapGitOps::test_bootstrap_plain_python_repo -v -s
  artifacts:
    when: on_failure
    paths:
      - pytest-logs/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - src/huskycat/commands/bootstrap.py
        - src/huskycat/hooks/**/*.py
        - tests/e2e/**/*.py
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - src/huskycat/commands/bootstrap.py
        - src/huskycat/hooks/**/*.py
        - tests/e2e/**/*.py

# E2E: Test hook execution (pre-commit, pre-push, commit-msg)
test:e2e:hooks:execution:
  stage: test
  image: python:3.11-alpine
  <<: *e2e_retry
  needs: []
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev linux-headers
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
    - git config --global user.name "CI Test"
    - git config --global user.email "ci@test.com"
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "=== E2E Test - Hook Execution ==="
    - uv sync --dev
    # Test valid cases
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapGitOps::test_hook_execution_pre_commit_valid -v -s
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapGitOps::test_hook_execution_commit_msg_valid_format -v -s
    # Test validation blocks invalid code
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapGitOps::test_hook_execution_pre_commit_invalid_syntax -v -s
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapGitOps::test_hook_execution_commit_msg_invalid_format -v -s
  artifacts:
    when: on_failure
    paths:
      - pytest-logs/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - src/huskycat/hooks/**/*.py
        - tests/e2e/**/*.py
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - src/huskycat/hooks/**/*.py
        - tests/e2e/**/*.py

# E2E: Test fast mode integration in hooks
test:e2e:fast:mode:
  stage: test
  image: python:3.11-alpine
  <<: *e2e_retry
  needs: []
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev linux-headers
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
    - git config --global user.name "CI Test"
    - git config --global user.email "ci@test.com"
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "=== E2E Test - Fast Mode in Hooks ==="
    - uv sync --dev
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapGitOps::test_gitops_fast_mode_in_hooks -v -s
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapGitOps::test_gitlab_ci_validation_in_hooks -v -s
  artifacts:
    when: on_failure
    paths:
      - pytest-logs/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - src/huskycat/hooks/**/*.py
        - src/huskycat/core/mode_detector.py
        - tests/e2e/**/*.py
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - src/huskycat/hooks/**/*.py
        - src/huskycat/core/mode_detector.py
        - tests/e2e/**/*.py

# E2E: Test edge cases and error handling
test:e2e:edge:cases:
  stage: test
  image: python:3.11-alpine
  <<: *e2e_retry
  needs: []
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev linux-headers
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
    - git config --global user.name "CI Test"
    - git config --global user.email "ci@test.com"
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "=== E2E Test - Edge Cases ==="
    - uv sync --dev
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapEdgeCases::test_bootstrap_non_git_directory -v -s
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapEdgeCases::test_bootstrap_empty_git_repo -v -s
    - uv run pytest tests/e2e/test_bootstrap_gitops.py::TestBootstrapGitOps::test_force_regenerate_hooks -v -s
  artifacts:
    when: on_failure
    paths:
      - pytest-logs/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - src/huskycat/commands/bootstrap.py
        - tests/e2e/**/*.py
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - src/huskycat/commands/bootstrap.py
        - tests/e2e/**/*.py

# E2E: Comprehensive test suite (runs all E2E tests together)
# Only runs on schedule or tags - comprehensive validation
test:e2e:comprehensive:
  stage: test
  image: python:3.11-alpine
  <<: *e2e_retry
  needs: []
  before_script:
    - apk add --no-cache git curl bash gcc musl-dev linux-headers
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
    - git config --global user.name "CI Test"
    - git config --global user.email "ci@test.com"
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  script:
    - echo "=== E2E Test - Comprehensive Test Suite ==="
    - uv sync --dev
    - uv run pytest tests/e2e/ -v -s --tb=short
  coverage: '/TOTAL.*\s+(\d+)%/'
  artifacts:
    when: always
    reports:
      junit: pytest-results.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
      - pytest-logs/
    expire_in: 1 week
  rules:
    # Always run on schedule and tags (comprehensive validation)
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_TAG
  allow_failure: true  # Don't block on E2E tests for now
