# Automated push mirror to GitHub.
# Syncs all branches and tags from GitLab to GitHub on every main push and tag.
# Requires CI variable: GITHUB_MIRROR_KEY (ed25519 private key with write access)

mirror:github:
  stage: deploy
  image: alpine:3.19
  needs: []
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  before_script:
    - apk add --no-cache git openssh-client
    - mkdir -p ~/.ssh
    - echo "$GITHUB_MIRROR_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - git remote add github git@github.com:jesssullivan/tinyland-huskycat.git 2>/dev/null || true
    - git remote set-url github git@github.com:jesssullivan/tinyland-huskycat.git
    - git push github --mirror --force
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
  allow_failure: true
  resource_group: github-mirror
