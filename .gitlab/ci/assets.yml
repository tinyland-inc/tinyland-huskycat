# SPDX-License-Identifier: Apache-2.0
# Icon and asset generation for HuskyCat packaging
# Generates raster icons from SVG source for all platforms

variables:
  ICON_SIZES: "16 32 48 64 128 256 512"

# Generate PNG icons from SVG
assets:icons:
  stage: build
  image: alpine:3.19
  before_script:
    - apk add --no-cache inkscape imagemagick
  script:
    - mkdir -p dist/icons

    # Generate PNG icons at all sizes
    - |
      for size in $ICON_SIZES; do
        inkscape assets/icons/huskycat.svg \
          -w $size -h $size \
          -o dist/icons/huskycat-${size}.png
        echo "Generated: huskycat-${size}.png"
      done

    # Generate symbolic icons for Linux
    - |
      for size in 16 24 32 48; do
        inkscape assets/icons/huskycat-symbolic.svg \
          -w $size -h $size \
          -o dist/icons/huskycat-symbolic-${size}.png
        echo "Generated: huskycat-symbolic-${size}.png"
      done

    # Generate Windows ICO (multi-resolution)
    - |
      convert \
        dist/icons/huskycat-16.png \
        dist/icons/huskycat-32.png \
        dist/icons/huskycat-48.png \
        dist/icons/huskycat-256.png \
        dist/icons/huskycat.ico
      echo "Generated: huskycat.ico"

    # Copy originals
    - cp assets/icons/huskycat.svg dist/icons/
    - cp assets/icons/huskycat-symbolic.svg dist/icons/

    # List generated assets
    - ls -la dist/icons/
  artifacts:
    paths:
      - dist/icons/
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - assets/icons/**/*

# Generate macOS .icns bundle
assets:macos-icons:
  extends: .macos_saas_runners
  stage: build
  needs:
    - job: assets:icons
      artifacts: true
  script:
    - mkdir -p huskycat.iconset

    # Create iconset with all required sizes
    - |
      for size in 16 32 128 256 512; do
        cp dist/icons/huskycat-${size}.png huskycat.iconset/icon_${size}x${size}.png

        # Create @2x retina versions
        double=$((size * 2))
        if [ $double -le 512 ]; then
          cp dist/icons/huskycat-${double}.png huskycat.iconset/icon_${size}x${size}@2x.png
        fi
      done

    # Generate .icns
    - iconutil -c icns huskycat.iconset -o dist/icons/huskycat.icns
    - rm -rf huskycat.iconset

    # Verify
    - file dist/icons/huskycat.icns
    - ls -la dist/icons/
  artifacts:
    paths:
      - dist/icons/huskycat.icns
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_TAG

# Validate desktop files
assets:validate-desktop:
  stage: test
  image: alpine:3.19
  before_script:
    - apk add --no-cache desktop-file-utils
  script:
    # Validate .desktop files
    - desktop-file-validate assets/linux/huskycat.desktop
    - desktop-file-validate assets/linux/huskycat-tray.desktop
    - echo "Desktop files validated successfully"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - assets/linux/**/*
    - if: $CI_COMMIT_TAG
