# GitLab Pages deployment for documentation and downloads

pages:
  stage: deploy
  image: python:3.11-slim
  before_script:
    # Install mkdocs and dependencies
    - pip install --no-cache-dir mkdocs mkdocs-material mkdocs-mermaid2-plugin pyyaml
  script:
    # Build documentation directly to public directory
    - mkdocs build --site-dir public

    # Generate LLM-friendly documentation formats
    - echo "Generating LLM-friendly documentation formats..."
    - python scripts/generate-llms-docs.py

    # Create downloads directory
    - mkdir -p public/downloads

    # Copy binary artifacts if they exist
    - |
      if [ -d "dist/binaries" ]; then
        cp -r dist/binaries/* public/downloads/ || true
      fi

    # Copy release artifacts from previous jobs
    - |
      for artifact in huskycat-*; do
        if [ -f "$artifact" ]; then
          cp "$artifact" public/downloads/
        fi
      done

    # Generate downloads index
    - |
      cat > public/downloads/index.html << 'EOF'
      <!DOCTYPE html>
      <html>
      <head>
        <title>HuskyCat Downloads</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
          h1 { color: #333; }
          .downloads { list-style: none; padding: 0; }
          .downloads li { margin: 10px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; }
          .downloads a { color: #0066cc; text-decoration: none; font-weight: 500; }
          .downloads a:hover { text-decoration: underline; }
          .meta { color: #666; font-size: 0.9em; margin-top: 5px; }
          .install-cmd { background: #2d2d2d; color: #fff; padding: 15px; border-radius: 5px; margin: 20px 0; font-family: monospace; }
        </style>
      </head>
      <body>
        <h1>HuskyCat Downloads</h1>
        <p>Binary releases and installation scripts for HuskyCat.</p>

        <h2>Quick Install</h2>
        <div class="install-cmd">curl -sSL https://tinyland.gitlab.io/ai/huskycat/install.sh | bash</div>

        <h2>Binary Releases</h2>
        <ul class="downloads">
      EOF

      # List all downloads
      for file in public/downloads/*; do
        if [ -f "$file" ] && [ "$(basename "$file")" != "index.html" ]; then
          filename=$(basename "$file")
          size=$(du -h "$file" | cut -f1)
          echo "<li><a href=\"$filename\">$filename</a><div class=\"meta\">Size: $size</div></li>" >> public/downloads/index.html
        fi
      done

      echo "</ul></body></html>" >> public/downloads/index.html

    # Copy verified install script from scripts/
    - cp scripts/install.sh public/install.sh
    - chmod +x public/install.sh

  artifacts:
    paths:
      - public

  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

  environment:
    name: production
    url: https://huskycat-570fbd.gitlab.io
