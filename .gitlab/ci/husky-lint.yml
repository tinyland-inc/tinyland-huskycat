# Complete GitLab CI configuration with linting, testing, and security scanning

stages:
  - validate
  - lint
  - test
  - security
  - build
  - deploy

variables:
  # Cache directories
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  npm_config_cache: "$CI_PROJECT_DIR/.cache/npm"
  YARN_CACHE_FOLDER: "$CI_PROJECT_DIR/.cache/yarn"

  # Python settings
  PYTHON_VERSION: "3.11"

  # Node settings
  NODE_VERSION: "18"

  # Performance
  PARALLEL_JOBS: 4

# Cache configuration
.cache_template: &cache_config
  cache:
    key:
      files:
        - package-lock.json
        - requirements.txt
        - pyproject.toml
    paths:
      - .cache/pip
      - .cache/npm
      - .cache/yarn
      - node_modules/
      - .venv/

# =============================================================================
# VALIDATION STAGE
# =============================================================================

validate:commit-messages:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - |
      if [ "$CI_MERGE_REQUEST_ID" ]; then
        echo "Validating commit messages for merge request..."
        PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-zA-Z0-9_-]+\))?: .+"

        git log --format=%s origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME..HEAD | while read -r commit; do
          if ! echo "$commit" | grep -qE "$PATTERN"; then
            echo "‚ùå Invalid commit message: $commit"
            echo "Expected format: <type>(<scope>): <subject>"
            exit 1
          fi
        done
        echo "‚úÖ All commit messages are valid"
      fi
  rules:
    - if: '$CI_MERGE_REQUEST_ID'

validate:branch-name:
  stage: validate
  image: alpine:latest
  script:
    - |
      BRANCH_PATTERN="^(main|develop|feature|bugfix|hotfix|release)/.+$"
      if ! echo "$CI_COMMIT_BRANCH" | grep -qE "$BRANCH_PATTERN"; then
        echo "‚ùå Invalid branch name: $CI_COMMIT_BRANCH"
        echo "Expected format: <type>/<description>"
        echo "Types: main, develop, feature, bugfix, hotfix, release"
        exit 1
      fi
      echo "‚úÖ Branch name is valid"
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && $CI_COMMIT_BRANCH != "develop"'

# =============================================================================
# LINT STAGE
# =============================================================================

lint:python:
  stage: lint
  image: python:${PYTHON_VERSION}
  <<: *cache_config
  before_script:
    - pip install --upgrade pip
    - pip install black flake8 mypy safety pylint isort bandit
    - if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
  script:
    - echo "üîç Running Black formatter check..."
    - black --check --diff .

    - echo "üîç Running isort import checker..."
    - isort --check-only --diff .

    - echo "üîç Running Flake8 linter..."
    - flake8 . --count --statistics

    - echo "üîç Running pylint..."
    - find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | xargs pylint || true

    - echo "üîç Running mypy type checker..."
    - mypy . || true

    - echo "üîç Running bandit security linter..."
    - bandit -r . -f json -o bandit-report.json || true

    - echo "üîç Running safety dependency check..."
    - safety check --json || true
  artifacts:
    reports:
      junit: flake8-report.xml
    paths:
      - bandit-report.json
    expire_in: 1 week
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "**/*.py"
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

lint:ansible:
  stage: lint
  image: python:${PYTHON_VERSION}
  <<: *cache_config
  before_script:
    - pip install ansible ansible-lint
  script:
    - echo "üîç Running ansible-lint..."
    - |
      find . \( -name "*.yml" -o -name "*.yaml" \) -type f | while read -r file; do
        if [[ "$file" =~ (playbook|role|task|handler|var|inventory|ansible) ]] || \
           grep -q -E '(hosts:|tasks:|roles:|handlers:|vars:|ansible)' "$file" 2>/dev/null; then
          echo "Linting: $file"
          ansible-lint "$file" || EXIT_CODE=$?
        fi
      done
      exit ${EXIT_CODE:-0}
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "**/*.yml"
        - "**/*.yaml"
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

lint:javascript:
  stage: lint
  image: node:${NODE_VERSION}
  <<: *cache_config
  before_script:
    - npm ci || npm install
  script:
    - echo "üîç Running ESLint..."
    - npx eslint . --ext .js,.jsx,.ts,.tsx --format junit --output-file eslint-report.xml

    - echo "üîç Running Prettier check..."
    - npx prettier --check .
  artifacts:
    reports:
      junit: eslint-report.xml
    expire_in: 1 week
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "**/*.js"
        - "**/*.jsx"
        - "**/*.ts"
        - "**/*.tsx"
        - "package*.json"
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

lint:shell:
  stage: lint
  image: koalaman/shellcheck-alpine:stable
  script:
    - echo "üîç Running shellcheck..."
    - find . -name "*.sh" -type f -not -path "./node_modules/*" | xargs shellcheck -x
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "**/*.sh"
        - "**/*.bash"
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

lint:docker:
  stage: lint
  image: hadolint/hadolint:latest-alpine
  script:
    - echo "üîç Running hadolint..."
    - find . -name "Dockerfile*" -type f | xargs hadolint
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "**/Dockerfile*"
        - "**/*.dockerfile"
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

lint:terraform:
  stage: lint
  image: hashicorp/terraform:latest
  script:
    - echo "üîç Running Terraform validation..."
    - |
      find . -name "*.tf" -type f | xargs -I {} dirname {} | sort -u | while read -r dir; do
        echo "Validating Terraform in: $dir"
        cd "$dir"
        terraform init -backend=false
        terraform fmt -check=true -diff
        terraform validate
        cd -
      done
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "**/*.tf"
        - "**/*.tfvars"
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

lint:yaml:
  stage: lint
  image: python:${PYTHON_VERSION}-alpine
  before_script:
    - pip install yamllint
  script:
    - echo "üîç Running yamllint..."
    - yamllint -c .yamllint . || yamllint .
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "**/*.yml"
        - "**/*.yaml"
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

# =============================================================================
# SECURITY STAGE
# =============================================================================

security:secrets:
  stage: security
  image: trufflesecurity/trufflehog:latest
  script:
    - echo "üîç Scanning for secrets..."
    - trufflehog git file://. --since-commit HEAD~${COMMIT_DEPTH:-10} --json > secrets-report.json || true
    - |
      if [ -s secrets-report.json ]; then
        echo "‚ö†Ô∏è  Potential secrets found!"
        cat secrets-report.json
        exit 1
      fi
  artifacts:
    paths:
      - secrets-report.json
    expire_in: 1 week
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

security:dependencies:
  stage: security
  image: node:${NODE_VERSION}
  <<: *cache_config
  script:
    - echo "üîç Running npm audit..."
    - npm audit --audit-level=moderate || true

    - echo "üîç Running npm audit fix (dry-run)..."
    - npm audit fix --dry-run || true
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "package*.json"
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

security:container-scan:
  stage: security
  image: aquasec/trivy:latest
  script:
    - echo "üîç Scanning container images..."
    - |
      for dockerfile in $(find . -name "Dockerfile*" -type f); do
        dir=$(dirname "$dockerfile")
        echo "Building and scanning image from: $dockerfile"
        docker build -f "$dockerfile" -t "scan-image:$CI_COMMIT_SHORT_SHA" "$dir" || continue
        trivy image "scan-image:$CI_COMMIT_SHORT_SHA"
      done
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "**/Dockerfile*"
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

security:sast:
  stage: security
  image: semgrep/semgrep:latest
  script:
    - echo "üîç Running Semgrep SAST..."
    - semgrep --config=auto --json --output=semgrep-report.json . || true
  artifacts:
    paths:
      - semgrep-report.json
    expire_in: 1 week
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

# =============================================================================
# TEST STAGE
# =============================================================================

test:unit:
  stage: test
  image: python:${PYTHON_VERSION}
  <<: *cache_config
  script:
    - echo "üß™ Running unit tests..."
    - |
      if [ -f pytest.ini ] || [ -f setup.cfg ] || [ -f pyproject.toml ]; then
        pip install pytest pytest-cov
        pytest --cov=. --cov-report=xml --cov-report=term
      elif [ -f manage.py ]; then
        python manage.py test
      else
        echo "No Python tests found"
      fi
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

test:integration:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - echo "üì¶ Installing podman-compose..."
    - apk add --no-cache python3 py3-pip
    - pip3 install podman-compose
  script:
    - echo "üß™ Running integration tests..."
    - |
      if [ -f podman-compose.test.yml ]; then
        podman-compose -f podman-compose.test.yml up --abort-on-container-exit
      else
        echo "No integration tests configured"
      fi
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

# =============================================================================
# QUALITY GATES
# =============================================================================

quality:gate:
  stage: test
  image: alpine:latest
  script:
    - echo "üö¶ Checking quality gates..."
    - |
      # Check if all required jobs passed
      FAILED=false

      # Add your quality gate checks here
      # Example: Check code coverage threshold
      # if [ "$COVERAGE" -lt "80" ]; then
      #   echo "‚ùå Code coverage below 80%"
      #   FAILED=true
      # fi

      if [ "$FAILED" = "true" ]; then
        echo "‚ùå Quality gates failed"
        exit 1
      fi

      echo "‚úÖ All quality gates passed"
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_BRANCH == "main"'

# =============================================================================
# SCHEDULED MAINTENANCE
# =============================================================================

schema:update:
  stage: build
  image: node:18-alpine
  only:
    - schedules
  variables:
    SCHEDULE_TYPE: "schema_update"
  before_script:
    - echo "üì¶ Installing dependencies..."
    - npm install -g uv
    - uv tool install huskycat
  script:
    - echo "üîÑ Updating validation schemas..."
    - huskycat update-schemas --force
    - huskycat update-schemas --helm --force
    - echo "‚úÖ Schemas updated successfully"
  artifacts:
    paths:
      - ~/.cache/huskycats/
    expire_in: 30 days
  rules:
    - if: '$SCHEDULE_TYPE == "schema_update"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
