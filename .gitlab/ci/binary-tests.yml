# Binary Testing Stage
# Tests built binaries on multiple platforms to verify:
# - Binary execution
# - Tool extraction
# - Bootstrap installation
# - Hook generation

.binary-test-template:
  stage: sign  # Must run after package stage where binaries are built
  image: python:3.13-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq git bash curl
    - pip install pytest
  script:
    - chmod +x ${BINARY_PATH}
    - bash scripts/verify_binary.sh ${BINARY_PATH}
    - pytest tests/test_binary_bootstrap.py --binary=${BINARY_PATH} -v
  artifacts:
    when: always
    reports:
      junit: test-reports/binary-bootstrap-*.xml
    paths:
      - test-reports/
    expire_in: 1 week
  retry:
    max: 1
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

binary:test:linux-amd64:
  extends: .binary-test-template
  dependencies:
    - build:binary:linux-amd64
  variables:
    BINARY_PATH: dist/bin/huskycat-linux-amd64
  tags:
    - dind
    - linux
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# NOTE: Linux ARM64 test removed - not a supported platform
# NOTE: macOS Intel test removed - no corresponding build job

binary:test:darwin-arm64:
  stage: sign  # Must run after package stage where binaries are built
  dependencies:
    - build:binary:darwin-arm64
  variables:
    BINARY_PATH: dist/bin/huskycat-darwin-arm64
  tags:
    - native
    - darwin
  before_script:
    - pip3 install pytest || python3 -m pip install pytest
  script:
    - chmod +x ${BINARY_PATH}
    - bash scripts/verify_binary.sh ${BINARY_PATH}
    - pytest tests/test_binary_bootstrap.py --binary=${BINARY_PATH} -v
  artifacts:
    when: always
    reports:
      junit: test-reports/binary-bootstrap-darwin-arm64.xml
    paths:
      - test-reports/
    expire_in: 1 week
  allow_failure: true  # macOS ARM64 runners may not always be available
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Quick smoke test that runs on any Linux runner
binary:smoke-test:
  stage: sign  # Must run after package stage where binaries are built
  image: python:3.13-slim
  dependencies:
    - build:binary:linux-amd64
  before_script:
    - apt-get update -qq && apt-get install -y -qq git bash
  script:
    - chmod +x dist/bin/huskycat-linux-amd64
    - ./dist/bin/huskycat-linux-amd64 --version
    - ./dist/bin/huskycat-linux-amd64 --help
    - echo "âœ“ Binary smoke test passed"
  tags:
    - dind
    - linux
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
